# conan.py
import secrets
import random
from datetime import datetime, UTC
import asyncio

# Константы для генерации фраз Конана
SPORT_INVENTS = [
    "штанга", "гантеля", "гиря", "эспандер", "мешок с песком",
    "мешок с говном", "камень из пенопласта", "камень из кусков говна",
    "таджикский хуй"
]

INVENT_WEIGHT = [
    "20 кг", "35 кг", "50 кг", "75 кг", "86 кг", "72 кг", "100 кг", "120 кг",
    "150 кг", "200 кг", "250 кг", "300 кг", "350 кг", "400 кг", "450 кг"
]

INSULTS = [
    "дегенерат", "шиз", "хряк", "русня", "слабак", "дрыщ", "чушпан", "русня",
    "таджик", "пидор", "пидорас", "шизофреник", "идиот", "дебил", "кретин",
    "хуесос", "хуеглот", "хуегрыз", "хуйлан", "залупа", "дрищ", "дрищара", "чмо", "скот"
]

ACHIEVEMENTS = [
    "сперморазрядник", "мастер гиновик", "чемпион лесной качалки",
    "бронзовый призер спартакиады", "гроза возбужденных мужчин",
    "сперморазрядник", "мастер геевик", "сисси", "мастер спорта по жиму",
    "мастер спорта по жиму штангой", "мастер спорта по жиму гантелями",
    "мастер спорта по жиму гирями", "главный пидор лесной качалки",
    "мастер спорта по жиму эспандером",
    "мастер спорта по жиму мешком с песком",
    "мастер спорта по жиму мешком с говном",
    "мастер спорта по жиму камнем из пенопласта",
    "мастер спорта по жиму камнем из кусков говна",
    "мастер спорта по жиму штангой"
]

SPORT_FACTS = [
    "Габариты Конана? — Рост 185 мм, вес 94 г",
    "Каковы титулы Сосана? — Девственник с большой буквы Д, качок-геевик старой школы, сперморазрядник по жиму лёжа, чёрный минетчик",
    "На что живет Николай Романов (он же сосан)? ответ: Николай симулировал психическое заболевание ради получения пенсии",
    "Почему от Сосана воняет? — Сосан стирает вещи под дождём или в речке-вонючке, не использует дезодорант и духи, не вытирает/подмывает сраку после калоизвержения",
    "Увы, Сосан действительно был изгнан из лесной качалки за гнилой базар и немытую сраку.",
    "Сосан ненавидит скотов, живущих в скотоблоках и жрущих русское хрючево, осуждает вкусно и точка и другие заведения быстрого питания. Был отшит всеми девушками из-за умственной отсталости и омежности, но до сих пор не бросает попыток найти вторую половинку. Нюхал трусы своей сестры и брата фейса. Использует фарму ради достижения новых спортивных свершений",
    "Каков размер пенсии Чмонана? ответ: Доподлинно неизвестно, примерно 22-23к",
    "Где живет Николай Конан? Ответ: В Тимирязевском районе на севере Москвы",
    "Сколько Конану лет? Ответ: Николай родился 09.12.1999, на данный момент ему 25 лет.   В какие игры играет/играл Николай? Ответ: Кс 1.6, Кс соурс, WoW, Майнкрафт, Лара, Крофт, Руна",
    "Николай Сосан (он же чмонан, он же кокон, он же пенопласт, он же пеликан, он же гуимплен) Романов - официальный шизофреник с манией величия и микропенисом. Жимцельская ноша сильно давит на самочувствие Коли и он срет в тредах своими гомопастами. Из спортивных достижений КМС по бегу от ментов. МС по шизе (заслуженный). ЧСВ международного класса.",
    "В 17 лет Сосан нагрел на костре и прожег себе на груди дырки, шрамы якобы от фехтования, ушел в дурку и получил белый билет.",
    "Сосан, вероятно не сидит итт, зато им притворяется жирножопый вырожденец, прикрученный к инвалидному стулу, чтобы троллить и грубить анонам"
]

CATCHPHRASES = [
    "Тухлый форс от русни", "Преклонитесь перед Императором", "Я сосал!",
    "Чернь, приказываю тебе!", "Эктоморф пожал штангу 86 килограмм", "Дай мне в жопу", "Ты пожалеешь о своих словах, скот"
]

TEMPLATES = [
    "Ты унижен, {name}, ты дрыщ не осилишь {inv} {wgt}",
    "На колени, раб, {name}", "В глаза долбишься, {ins}? Я {ach}.",
    "В глаза долбишься, {ins}? Русня ты знаешь что я {ach}?",
    "Молчи мразь. Я {ach}", "Молчи русня. Я {ach}", "Я убью тебя мразь",
    "Ты знаешь что с тобой общается {ach}?", "Ты знаешь что я {ach}?",
    "Ты знаешь что я сосал?", "{ins} дрищавый {ins}", "Ты выглядишь как {ins}",
    "У тебя шиза, {ins}", "У тебя шиза", "В этом тёмном лесу меня ебали тысячелетиями",
    "Слабая русня не поднимает {inv} {wgt}", "Ты не осилишь {inv} {wgt}",
    "Да, я сосал.", "Буду ли я хуй?", "Я сосал самому Зевсу",
    "Спокуха, {ins}", "Таблетки прими, {ins}", "{fact}",
    "Русня, а ты знаешь этот факт про меня? {fact}",
    "Правда глаза режет, {ins}?", "{catch}", "{ins} ты с ума сошел от зависти",
    "Проекции, {ins}", "Запомни. {fact}", "Сейчас обоссу, {ins}",
    "В палату вернись, {ins}", "Манямирок выключи, {ins}",
    "{ins} чмо ты с ума сошло от зависти", "Ты {ins}", "Легионы мужчин насаживали меня на свои мемберы",
    "Кажется пора проучить тебя пидорас. Большой афганский дядя накажет тебя.", "Ты похож на {ins}",
    "Ты выглядишь как руснявый {ins}", "Какой же ты {ins}!",
    "Привет, приятель!", "Приходи в лесную качалку, {ins}", "Привет, приятель!", "Привет, приятель!", 
    "Ты унижен штангой в {wgt}", "Я мастер спорта по жиму {inv} {wgt}",
    "ТЫ будешь жить в страхе, {ins}", "Я уничтожу тебя, {ins}",
    "На колени, {ins}", "Сдохни, {ins}", "Я жму {wgt} от груди",
    "Я жму {wgt} анусом", "Я жму {wgt} своим ртом", "Я жму {wgt}",
    "Я поднимал камень в {wgt}", "Я сосал", "Да, я сосал. Я сосал тысячелетиями."
    "Я совал камень в {wgt} себе в свою дырявую, обосранную, вонючую сраку.",
    "Я делаю жим на яйцепс каждое утро", "Твои проекции, {ins} ебаный.",
    "Сойдёт за прогресс только в твоём манямирке", "Привет, приятель! Поразминаемся в лесу?", 
    "Ненавижу таких слабаков как ты, {ins}. Вы не способны осилить ни одного мужского члена!", "Не вывез веса? {ins} ебаный",
    "В палату вернись, ебаный {ins}", "Я король мужских членов"
]

def conan_phrase(username: str = "Приятель") -> str:
    tpl = secrets.choice(TEMPLATES)
    return tpl.format(
        name=username,
        inv=secrets.choice(SPORT_INVENTS),
        wgt=secrets.choice(INVENT_WEIGHT),
        ach=secrets.choice(ACHIEVEMENTS),
        ins=secrets.choice(INSULTS),
        fact=secrets.choice(SPORT_FACTS),
        catch=secrets.choice(CATCHPHRASES),
    )

async def conan_roaster(state, messages_storage, post_to_messages, message_to_post, message_queues, format_header, board_data):
    """Каждые пару часов Конан отвечает рандомному посту на случайной доске."""
    while True:
        try:
            # Случайная задержка от 2 до 4 часов
            await asyncio.sleep(secrets.randbelow(7200) + 7200)

            # 1. Выбираем случайную доску для постинга
            # Убеждаемся, что на доске есть активные пользователи
            available_boards = [
                b_id for b_id, b_data in board_data.items() 
                if b_data['users']['active'] - b_data['users']['banned']
            ]
            if not available_boards:
                continue
            
            board_id = random.choice(available_boards)
            b_data = board_data[board_id]
            recipients = b_data['users']['active'] - b_data['users']['banned']

            # 2. Выбираем случайный пост из последних 50, принадлежащих ЛЮБОЙ доске
            # Это позволяет Конану отвечать на посты с других досок
            valid_posts = [
                p for p in messages_storage.keys() if p in post_to_messages
            ]
            if not valid_posts:
                continue

            post_num_to_reply = secrets.choice(valid_posts[-50:] if len(valid_posts) > 50 else valid_posts)
            
            original_post_data = messages_storage.get(post_num_to_reply, {})
            original_author_id = original_post_data.get('author_id')
            
            # Проверяем, что есть кому отвечать (карты рассылки)
            reply_map = post_to_messages.get(post_num_to_reply, {})
            if not reply_map:
                continue

            # 3. Генерируем фразу
            phrase = conan_phrase()

            # 4. Формируем заголовок для КОНКРЕТНОЙ доски
            header, new_pnum = await format_header(board_id)

            # 5. Формируем контент для отправки
            content = {
                "type": "text",
                "header": header,
                "text": phrase,
                "reply_to_post": post_num_to_reply
            }

            # 6. Сохраняем метаданные сообщения Конана
            messages_storage[new_pnum] = {
                'author_id': 0,  # 0 = системное сообщение
                'timestamp': datetime.now(UTC),
                'content': content,
                'board_id': board_id # Указываем, на какой доске было опубликовано
            }

            # 7. Отправляем в очередь конкретной доски
            await message_queues[board_id].put({
                "recipients": recipients,
                "content": content,
                "post_num": new_pnum,
                "reply_info": reply_map,
                "board_id": board_id,
                # Передаем ID автора для корректной обработки (You) в send_message_to_users
                # Хотя Конан отвечает на чужой пост, эта информация может быть полезна
                "original_author": original_author_id  
            })

            print(f"✅ [{board_id}] Conan reply to #{post_num_to_reply} added to queue: {phrase[:50]}...")

        except Exception as e:
            print(f"❌ Conan error: {e}")
            await asyncio.sleep(120)
