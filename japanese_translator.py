# japanese_translator.py
import random
import re
import os
import aiohttp
from aiohttp import ClientTimeout
try:
    from main import escape_html
except ImportError:
    # Запасной вариант, если файл используется отдельно
    def escape_html(text: str) -> str:
        if not text: return text
        return text.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('"', '&quot;')


# --- НОВЫЙ СУЩЕСТВЕННО РАСШИРЕННЫЙ СЛОВАРЬ ПЕРЕВОДОВ ---
JAPANESE_WORD_REPLACEMENTS = {
    # --- Местоимения (Pronouns) ---
    # Личные местоимения
    "я": ["私", "俺", "僕", "わたくし"],
    "ты": ["君", "お前", "あなた"],
    "вы": ["あなた", "君たち", "お前ら"],
    "он": ["彼", "あいつ"],
    "она": ["彼女", "あの子"],
    "оно": ["それ"],
    "мы": ["私達", "我々"],
    "они": ["彼ら", "あいつら"],
    
    # Указательные местоимения
    "это": ["これ", "それ"],
    "то": ["あれ"],
    "себя": ["自分"],
    
    # Притяжательные местоимения (мужской/средний род)
    "мой": ["私の", "俺の", "僕の"],
    "твой": ["君の", "お前の"],
    "его": ["彼の", "あいつの"],
    "наш": ["私達の", "我々の"],
    "ваш": ["あなたの", "あなたがたの"],
    "их": ["彼らの", "あいつらの"],
    
    # Женский род
    "моя": ["私の", "俺の", "僕の"],
    "твоя": ["君の", "お前の"],
    "её": ["彼女の", "あの子の"],
    
    # Множественное число
    "мои": ["私の", "俺の", "僕の"],
    "твои": ["君の", "お前の"],
    "наши": ["私達の", "我々の"],
    "ваши": ["あなたの", "あなたがたの"],
    # "их" уже определен выше, дубликат убран
    
    # Возвратные
    "свой": ["自分の"],
    "своя": ["自分の"],
    "своё": ["自分の"],
    "свои": ["自分の"],

    # --- Вопросительные слова (Question Words) ---
    "кто": "誰", "кого": "誰に", "каво": "誰に", "шо": ["何", "何が"], "что": ["何", "何が"], "че": ["何", "何が"], "чё": ["何", "何が"], "где": "どこ", "когда": "いつ", "почему": ["なぜ", "どうして"], "как": "どう", "какой": "どの", "сколько": "いくつ", "чей": "誰の",

    # --- Частотные слова и частицы (Common words & Particles) ---
    "да": ["はい", "うん", "ええ", "そう"],
    "нет": ["いいえ", "いや", "ううん"],
    "привет": ["こんにちは", "やあ", "どうも", "ハロー"],
    "пока": ["じゃあね", "またね", "バイバイ", "失礼します"],
    "спасибо": ["ありがとう", "どうも", "ありがとうございます"],
    "пожалуйста": ["どうぞ", "お願いします"],
    "извини": ["ごめん", "ごめんなさい", "すみません"],
    "хорошо": ["良い", "いい", "結構", "大丈夫"],
    "плохо": ["悪い", "ダメ", "良くない"],
    "очень": ["とても", "すごく", "めっちゃ", "超"],
    "тоже": "も", "еще": "もっと", "уже": "もう", "конечно": "もちろん", "просто": "ただ",
    "человек": ["人", "人間"], "люди": "人々", "друг": ["友達", "友人"], "враг": "敵", "парень": "彼氏", "девушка": "彼女",
    "бог": "神様", "жизнь": "人生", "смерть": "死", "любовь": "愛", "ненависть": "憎しみ",
    "день": "日", "ночь": "夜", "утро": "朝", "вечер": "夕方",
    "сегодня": "今日", "вчера": "昨日", "завтра": "明日",
    "дом": "家", "школа": "学校", "работа": "仕事", "страна": "国", "город": "町", "мир": "世界",

    # --- Интернет и общение (Internet & Communication) ---
    "лол": ["笑", "(笑)", "www", "草"], "кек": "草", "рофл": "冗談", "рофлить": "冗談を言う",
    "пост": ["投稿", "ポスト", "スレ"], "тред": "スレ", "коммент": "コメント", "ответ": "返信", "реплай": "リプライ",
    "админ": ["管理人", "管理者", "アドミン"], "модер": "モデレーター", "бан": ["バン", "垢BAN"], "забанить": "バンする",
    "бот": "ボット", "ник": ["ニックネーム", "ハンドルネーム"], "аватар": "アイコン",
    "чат": "チャット", "дискорд": "ディスコ", "телеграм": "テレグラム", "тг": "テレグラム",
    "сообщение": "メッセージ", "текст": ["テキスト", "文章"], "голосовое": "ボイスメッセージ", "гс": "ボイスメッセージ",
    "картинка": "画像", "пикча": "画像", "видео": "動画", "видос": "動画", "ссылка": "リンク", "сайт": "サイト",
    "правда": ["本当", "マジ", "ガチ"], "фейк": "偽", "инфа": "情報", "пруф": "証拠",
    "хейтер": "アンチ", "хейтить": "アンチする", "стрим": "配信", "стример": "配信者", "донат": "投銭",
    "скилл": "スキル", "скилловый": "上手い", "нуб": ["初心者", "雑魚", "ヘタクソ"], "про": "プロ", "топ": "トップ", "имба": "ぶっ壊れ", "топчик": "トップ",
    "игра": "ゲーム", "игрок": "プレイヤー", "тима": "チーム", "сквад": "チーム", "рейд": "レイド",
    "аниме": "アニメ", "аниму": "アニメ", "ониме": "アニメ", "онеме": "アニメ", "манга": "漫画", "тян": "ちゃん", "тянка": "ちゃん", "тня": "ちゃん", "кун": "くん", "вайфу": "嫁", "скуф": ["スクーフ", "スクーフタチ"], "скуфы": "スクーフタチ",
    "дегенерат": "デジェネラット", "шиз": "統合失調症", "русня": "ロシア人", "чушпан": "チュシパン",
    "сигма": "シグマ",
    "нормис": "一般人",
    "нормисы": "一般人たち",
    "зумер": "Z世代",
    "зумеры": "Z世代",
    "бумер": "ブーマー",
    "бумеры": "ブーマー",
    "милф": "MILF",
    "милфа": "MILF",
    "милфу": "MILF",
    "куколд": "寝取られ",
    "куколда": "寝取られ",
    "форс": "ゴリ押し",
    "форсят": "ゴリ押しする",
    "хз": "さあ",
    "имхо": "私見",
    "гг": ["GG", "お疲れ"],
    "изи": "簡単",
    "катка": "試合",
    "нерф": "弱体化",
    "афк": ["AFK", "離席中"],
    "саб": "購読",
    "фолловер": "フォロワー",
    "би лайк": "みたいな感じ",

    # --- Глаголы в разных формах (новое и уникальное) ---
    "хочешь": "欲しいか",
    "хочет": "欲しがってる",
    "хотим": "欲しい",
    "хотите": "欲しいですか",
    "хотят": "欲しがってる",
    "любишь": "愛してるか",
    "любит": "愛してる",
    "понимаешь": "分かるか",
    "понимает": "分かる",
    "знаешь": "知ってるか",
    "знает": "知ってる",
    "знаем": "知ってる",
    "знают": "知ってる",
    "думаешь": "思うか",
    "думает": "思う",
    "жди": "待って",
    "ждите": "待ってください",
    "иди": "行け",
    "идите": "行ってください",
    "смотри": "見て",
    "смотрите": "見てください",
    "слушай": "聞いて",
    "слушайте": "聞いてください",
    "скажи": "言って",
    "скажите": "言ってください",
    "делай": "して",
    "делайте": "してください",
    "работаю": "働いてる",
    "работаешь": "働いてる",
    "работает": "働いてる",
    "играю": "遊んでる",
    "играешь": "遊んでる",
    "играет": "遊んでる",
    "учусь": "勉強してる",
    "учишься": "勉強してる",
    "учится": "勉強してる",
    "помоги": "助けて",
    
    # --- Существительные (с формами, новое и уникальное) ---
    "анимешник": "アニオタ",
    "анимешники": "アニオタたち",
    "проблему": "問題を",
    "проблемой": "問題で",
    "вопросы": "質問",
    "вопроса": "質問の",
    "ответа": "答え",
    "смысла": "意味",
    "смысле": "意味で",
    "целью": "目的で",
    "мечту": "夢を",
    "мыслей": "考え",
    "идею": "アイデアを",
    "чувства": "気持ち",
    "чувств": "気持ち",
    "эмоций": "感情",
    "музыку": "音楽を",
    "фильма": "映画の",
    "книгу": "本を",
    "историю": "物語を",
    "школьники": "学生たち",
    "школьника": "学生の",
    "студенты": "大学生たち",
    "студента": "大学生の",
    "учителю": "先生に",
    "сенсей": "先生",
    "семпай": "先輩",
    "кохай": "後輩",
    "силы": "力",
    "силой": "力で",
    "магию": "魔法を",
    "монстры": "モンスター",
    "монстра": "モンスターの",
    "герои": "ヒーロー",
    "героя": "ヒーローの",
    "злодеи": "悪役",
    "злодея": "悪役の",
    "мира": "世界の",
    "миру": "世界に",
    "войны": "戦争",
    "войну": "戦争を",
    "жизни": "人生",
    "смерти": "死",

    # --- Прилагательные (с формами, новое и уникальное) ---
    "тупой": "馬鹿な",
    "тупая": "馬鹿な",
    "тупое": "馬鹿な",
    "тупые": "馬鹿な",
    "умный": "賢い",
    "умная": "賢い",
    "умное": "賢い",
    "умные": "賢い",
    "возможный": "可能",
    "возможная": "可能",
    "каждый": "各",
    "каждая": "各",
    "каждое": "各",
    "любой": "どんな",
    "пиздатый": ["すごい", "ヤバい"],
    "пиздатая": ["すごい", "ヤバい"],
    "пиздатое": ["すごい", "ヤバい"],
    "пиздатые": ["すごい", "ヤバい"],
    "охуенный": ["最高", "すげえ"],
    "охуенная": ["最高", "すげえ"],
    "охуенное": ["最高", "すげえ"],
    "охуенные": ["最高", "すげえ"],
    "хуевый": ["クソ", "最低"],
    "хуевая": ["クソ", "最低"],
    "хуевое": ["クソ", "最低"],
    "хуевые": ["クソ", "最低"],
    
    # --- Нецензурная лексика и грубости (формы и новое) ---
    "пидорасы": "ホモ野郎ども",
    "пидораса": "ホモ野郎の",
    "долбоебы": "大馬鹿ども",
    "еблана": "バカの",
    "ебланы": "バカども",
    "мудака": "ろくでなしの",
    "мудаки": "ろくでなしども",
    "гандоны": "クズども",
    "шлюхи": "ビッチども",
    "шлюху": "ビッチを",
    "заткнитесь": "黙れ",
    "умрите": "死ね",
    "сдохните": "くたばれ",
    "отвалите": "どけ",

    # --- Вещи и предметы (Things & Objects) ---
    "вещь": ["物", "アイテム", "もの"], "вещи": ["物", "アイテム", "もの"],
    "предмет": ["物", "アイテム", "対象物"], "предметы": ["物", "アイテム", "対象物"],
    "машина": ["車", "自動車", "カー"], "машины": ["車", "自動車", "カー"],
    "телефон": ["電話", "スマホ", "ケータイ"], "телефоны": ["電話", "スマホ", "ケータイ"],
    "компьютер": ["コンピュータ", "パソコン", "PC"], "компьютеры": ["コンピュータ", "パソコン", "PC"],
    "книга": ["本", "書籍", "ブック"], "книги": ["本", "書籍", "ブック"],
    "ключ": ["鍵", "キー"], "ключи": ["鍵", "キー"],
    "деньги": ["お金", "金", "マネー"], "деньгами": ["お金", "金", "マネー"],
    "кошелёк": ["財布", "ウォレット"], "кошельки": ["財布", "ウォレット"],
    "очки": ["眼鏡", "メガネ"], "очков": ["眼鏡", "メガネ"],
    "часы": ["時計", "ウォッチ"],
    "сумка": ["バッグ", "カバン"], "сумки": ["バッグ", "カバン"],
    "кофта": ["セーター", "トレーナー"], "кофты": ["セーター", "トレーナー"],
    "дверь": ["ドア", "戸"], "двери": ["ドア", "戸"],
    "окно": ["窓", "ウィンドウ"], "окна": ["窓", "ウィンドウ"],
    "стол": ["机", "テーブル"], "столы": ["机", "テーブル"],
    "стул": ["椅子", "チェア"], "стулья": ["椅子", "チェア"],
    "кровать": ["ベッド", "寝台"], "кровати": ["ベッド", "寝台"],
    "подушка": ["枕", "クッション"], "подушки": ["枕", "クッション"],
    "одеяло": ["布団", "毛布"], "одеяла": ["布団", "毛布"],
    
    # --- Еда и напитки (Food & Drinks) ---
    "еда": ["食べ物", "食品", "フード"], "еду": ["食べ物", "食品", "フード"],
    "вода": ["水", "ウォーター"], "воду": ["水", "ウォーター"], "воды": ["水", "ウォーター"], "водой": ["水で", "ウォーターで"],
    "хлеб": ["パン", "ブレッド"], "хлеба": ["パン", "ブレッド"],
    "рис": ["米", "ライス"], "риса": ["米", "ライス"],
    "мясо": ["肉", "ミート"], "мяса": ["肉", "ミート"],
    "рыба": ["魚", "フィッシュ"], "рыбу": ["魚", "フィッシュ"],
    "суп": ["スープ", "汁物"], "супа": ["スープ", "汁物"],
    "кофе": ["コーヒー", "珈琲"],
    "чай": ["お茶", "ティー"], "чая": ["お茶", "ティー"],
    "сок": ["ジュース", "果汁"], "сока": ["ジュース", "果汁"], "водяра": ["お酒", "アルコール"], "водки": ["お酒", "アルコール"],
    "алкоголь": ["お酒", "アルコール"], "алкоголя": ["お酒", "アルコール"], "бухло": ["お酒", "アルコール"], "бухла": ["お酒", "アルコール"], "водка": ["お酒", "アルコール"], "водку": ["お酒", "アルコール"],
    "пиво": ["ビール", "麦酒"], "пива": ["ビール", "麦酒"],
    
    # --- Природа (Nature) ---
    "дерево": ["木", "ツリー"], "деревья": ["木", "ツリー"],
    "цветок": ["花", "フラワー"], "цветы": ["花", "フラワー"],
    "трава": ["草", "グラス"], "травы": ["草", "グラス"],
    "лес": ["森", "森林"], "леса": ["森", "森林"],
    "гора": ["山", "マウンテン"], "горы": ["山", "マウンテン"],
    "река": ["川", "リバー"], "реки": ["川", "リバー"],
    "море": ["海", "シー"], "моря": ["海", "シー"],
    "небо": ["空", "スカイ"], "неба": ["空", "スカイ"],
    "солнце": ["太陽", "サン"], "солнца": ["太陽", "サン"],
    "луна": ["月", "ムーン"], "луны": ["月", "ムーン"],
    "звезда": ["星", "スター"], "звёзды": ["星", "スター"],
    
    # --- Тело человека (Human Body) ---
    "голова": ["頭", "ヘッド"], "головы": ["頭", "ヘッド"],
    "рука": ["腕", "アーム"], "руки": ["腕", "アーム"],
    "нога": ["足", "レッグ"], "ноги": ["足", "レッグ"],
    "глаз": ["目", "アイ"], "глаза": ["目", "アイ"],
    "ухо": ["耳", "イヤー"], "уши": ["耳", "イヤー"],
    "нос": ["鼻", "ノーズ"], "носа": ["鼻", "ノーズ"],
    "рот": ["口", "マウス"], "рта": ["口", "マウス"],
    "зуб": ["歯", "トゥース"], "зубы": ["歯", "トゥース"], "зуба": ["歯", "トゥース"], "зубов": ["歯", "トゥース"],
    "волосы": ["髪", "ヘアー"], "волос": ["髪", "ヘアー"],
    "сердце": ["心臓", "ハート"], "сердца": ["心臓", "ハート"],
    
    # --- Технологии (Technology) ---
    "интернет": ["インターネット", "ネット"], "интернета": ["インターネット", "ネット"],
    "программа": ["プログラム", "ソフト"], "программы": ["プログラム", "ソフト"],
    "приложение": ["アプリ", "アプリケーション"], "приложения": ["アプリ", "アプリケーション"],
    "фильм": ["映画", "ムービー"], "фильмы": ["映画", "ムービー"],
    "музыка": ["音楽", "ミュージック"], "музыку": ["音楽", "ミュージック"],
    "фото": ["写真", "フォト"], "фотографии": ["写真", "フォト"],
    
    # --- Город и транспорт (City & Transport) ---
    "улица": ["道", "ストリート"], "улицы": ["道", "ストリート"],
    "здание": ["建物", "ビル"], "здания": ["建物", "ビル"],
    "магазин": ["店", "ショップ"], "магазины": ["店", "ショップ"],
    "больница": ["病院", "ホスピタル"], "больницы": ["病院", "ホスピタル"],
    "школы": ["学校", "スクール"],
    "автобус": ["バス", "乗合車"], "автобусы": ["バス", "乗合車"],
    "поезд": ["電車", "列車"], "поезда": ["電車", "列車"],
    "самолёт": ["飛行機", "エアプレーン"], "самолёты": ["飛行機", "エアプレーン"],
    "велосипед": ["自転車", "バイク"], "велосипеды": ["自転車", "バイク"],
    
    # --- Время и даты (Time & Dates) ---
    "времени": ["時間", "タイム"],
    "часа": ["時間", "アワー"], "часов": ["時計", "ウォッチ"],
    "минуты": ["分", "ミニット"],
    "секунда": ["秒", "セカンド"], "секунды": ["秒", "セカンド"],
    "недели": ["週", "ウィーク"],
    "месяца": ["月", "マンス"],
    "года": ["年", "イヤー"],
    "века": ["世紀", "センチュリー"],
    
    # --- Семья (Family) ---
    "семья": ["家族", "ファミリー"], "семьи": ["家族", "ファミリー"],
    "отец": ["父", "父親"], "отца": ["父", "父親"],
    "мать": ["母", "母親"], "матери": ["母", "母親"],
    "сын": ["息子", "サン"], "сына": ["息子", "サン"],
    "дочь": ["娘", "ドーター"], "дочери": ["娘", "ドーター"],
    "брат": ["兄", "弟", "ブラザー"], "брата": ["兄", "弟", "ブラザー"],
    "сестра": ["姉", "妹", "シスター"], "сестры": ["姉", "妹", "シスター"],
    
    # --- Эмоции и состояния (Emotions & States) ---
    "любви": ["愛", "ラブ"],
    "ненависти": ["憎しみ", "ヘイト"],
    "счастье": ["幸せ", "ハピネス"], "счастья": ["幸せ", "ハピネス"],
    "грусть": ["悲しみ", "サッドネス"], "грусти": ["悲しみ", "サッドネス"],
    "страх": ["恐怖", "フィア"], "страха": ["恐怖", "フィア"],
    "злость": ["怒り", "アンガー"], "злости": ["怒り", "アンガー"],
    "усталость": ["疲れ", "疲労"], "усталости": ["疲れ", "疲労"],
    "болезнь": ["病気", "イルネス"], "болезни": ["病気", "イルネス"],
    
    # --- Действия (Actions) ---
    "бег": ["走ること", "ランニング"], "бега": ["走ること", "ランニング"],
    "прыжок": ["ジャンプ", "跳躍"], "прыжка": ["ジャンプ", "跳躍"],
    "танцы": ["ダンス", "踊り"], "танцев": ["ダンス", "踊り"],
    "пение": ["歌", "シンギング"], "пения": ["歌", "シンギング"],
    "чтение": ["読書", "リーディング"], "чтения": ["読書", "リーディング"],
    "письмо": ["書き物", "ライティング"], "письма": ["書き物", "ライティング"],
    
    # --- Абстрактные понятия (Abstract Concepts) ---
    "мысль": ["考え", "思考"], "мысли": ["考え", "思考"],
    "идея": ["アイデア", "考え"], "идеи": ["アイデア", "考え"],
    "проблема": ["問題", "トラブル"], "проблемы": ["問題", "トラブル"],
    "решение": ["解決", "ソリューション"], "решения": ["解決", "ソリューション"],
    "цель": ["目標", "ゴール"], "цели": ["目標", "ゴール"],
    "мечта": ["夢", "ドリーム"], "мечты": ["夢", "ドリーム"],
    
    # --- Животные (Animals) ---
    "собака": ["犬", "ドッグ"], "собаки": ["犬", "ドッグ"],
    "кошка": ["猫", "キャット"], "кошки": ["猫", "キャット"],
    "птица": ["鳥", "バード"], "птицы": ["鳥", "バード"],
    "рыбы": ["魚", "フィッシュ"],
    "лошадь": ["馬", "ホース"], "лошади": ["馬", "ホース"],
    "корова": ["牛", "カウ"], "коровы": ["牛", "カウ"],
    
    # --- Дополнительные бытовые предметы ---
    "ложка": ["スプーン", "匙"], "ложки": ["スプーン", "匙"],
    "вилка": ["フォーク", "叉"], "вилки": ["フォーク", "叉"],
    "нож": ["ナイフ", "包丁"], "ножа": ["ナイフ", "包丁"],
    "тарелка": ["皿", "プレート"], "тарелки": ["皿", "プレート"],
    "чашка": ["カップ", "茶碗"], "чашки": ["カップ", "茶碗"],
    "бутылка": ["瓶", "ボトル"], "бутылки": ["瓶", "ボトル"],
    
    # --- Погода (Weather) ---
    "дождь": ["雨", "レイン"], "дождя": ["雨", "レイン"],
    "снег": ["雪", "スノー"], "снега": ["雪", "スノー"],
    "ветер": ["風", "ウィンド"], "ветра": ["風", "ウィンド"],
    "туман": ["霧", "フォッグ"], "тумана": ["霧", "フォッグ"],
    "жара": ["暑さ", "ヒート"], "жары": ["暑さ", "ヒート"],
    "холод": ["寒さ", "コールド"], "холода": ["寒さ", "コールド"],
    
    # --- Профессии (Professions) ---
    "врач": ["医者", "ドクター"], "врача": ["医者", "ドクター"],
    "учитель": ["先生", "ティーチャー"], "учителя": ["先生", "ティーチャー"],
    "инженер": ["エンジニア", "技師"], "инженера": ["エンジニア", "技師"],
    "повар": ["料理人", "シェフ"], "повара": ["料理人", "シェフ"],
    "артист": ["芸能人", "アーティスト"], "артиста": ["芸能人", "アーティスト"],
    "водитель": ["運転手", "ドライバー"], "водителя": ["運転手", "ドライバー"],

    "в": ["で", "に", "の中に"], "во": ["で", "に"], "на": ["で", "に", "の上に"], "под": "の下に", "над": "の上に", "за": ["の後ろに", "のために"], "перед": "の前に", "с": ["と", "で"], "из": "から", "из-под": "の下から",
    "у": ["のところに", "で"], "к": ["に", "へ"], "по": ["で", "に沿って"],
    "о": "について", "об": "について", "от": "から", "до": "まで", "без": "なしで", "для": "のために", "через": ["を越えて", "後で"],
    "между": ["の間", "の間に"], "сквозь": "を通り抜けて", "среди": "の中で", "против": ["に反対して", "に対して"], "около": ["の近くに", "約"], "возле": "の近くに",
    "вдоль": "に沿って", "поперёк": "を横切って", "вокруг": "の周りに", "после": ["の後で", "後に"], "во время": "の間に", "в течение": "の間", "в продолжение": "の間", "вследствие": "のため", "в течении": "の間", "в продолжении": "の間", "вследствии": "のため", "из-за": "のために",
    "благодаря": "のおかげで", "согласно": "によると", "вопреки": "にもかかわらず", "несмотря на": "にもかかわらず", "и": "と", "а": ["だが", "一方で"], "но": ["しかし", "でも"],
    "или": "か", "чтобы": ["ために", "ように"], "если": "もし", "потому что": "なぜなら", "так как": "なので", "хотя": ["だけど", "にもかかわらず"],
    "когда": "時に", "где": "所で", "куда": ["所へ", "方向に"], "откуда": "から", "почему": "なぜ", "зачем": "なぜ", "ли": "かどうか",
    "бы": ["だろう", "でしょう"], "ведь": "だって", "мол": "と言って", "дескать": "と言って", "только": "だけ", "лишь": "だけ", "даже": "さえ", "уж": "もう", "неужели": "まさか", "разве": "まさか",

    "ноль": "零", "один": "一", "два": "二", "три": "三", "четыре": "四", "пять": "五", "шесть": "六",
    "семь": "七", "восемь": "八", "девять": "九", "десять": "十", "одиннадцать": "十一", "двенадцать": "十二",
    "тринадцать": "十三", "четырнадцать": "十四", "пятнадцать": "十五", "шестнадцать": "十六", "семнадцать": "十七",
    "восемнадцать": "十八", "девятнадцать": "十九", "двадцать": "二十", "тридцать": "三十", "сорок": "四十", "пятьдесят": "五十",
    "шестьдесят": "六十", "семьдесят": "七十", "восемьдесят": "八十", "девяносто": "九十", "сто": "百", "двести": "二百", "триста": "三百",
    "четыреста": "四百", "пятьсот": "五百", "шестьсот": "六百", "семьсот": "七百", "восемьсот": "八百", "девятьсот": "九百",
    "тысяча": "千", "миллион": "百万", "миллиард": "十億", "триллион": "一兆",
    "много": ["多い", "たくさん"], "мало": ["少ない", "少し"], "несколько": ["いくつか", "若干"], "больше": "もっと",
    "меньше": "もっと少ない", "половина": "半分", "треть": "三分の一", "четверть": "四分の一", "целый": "全体の", "пустой": "空の",
    "первый": "最初", "второй": "二番目", "третий": "三番目", "четвертый": "四番目", "пятый": "五番目",
    "последний": "最後", "одинарный": "単一の", "двойной": "二重の", "тройной": "三重の", "четверной": "四重の",
    
    # --- Глаголы и действия (Verbs & Actions) ---
    "был": "だった", "была": "だった", "было": "だった", "были": "だった",
    "ел": "食べた", "ела": "食べた", "ело": "食べた", "ели": "食べた",
    "пил": "飲んだ", "пила": "飲んだ", "пило": "飲んだ", "пили": "飲んだ",
    "сказал": "言った", "сказала": "言った", "сказало": "言った", "сказали": "言った", "скажу": "言うだろう", "говорил": "言った", "говорила": "言った", "говорило": "言った", "говорили": "言った",
    "сделал": "した", "сделала": "した", "сделало": "した", "сделали": "した", "делал": "した", "делала": "した", "делало": "した", "делали": "した",
    "посмотрел": "見た", "посмотрела": "見た", "посмотрело": "見た", "посмотрели": "見た", "смотрел": "見た", "смотрела": "見た", "смотрело": "見た", "смотрели": "見た",
    "увидел": "見えた", "увидела": "見えた", "увидело": "見えた", "увидели": "見えた", "видел": "見えた", "видела": "見えた", "видело": "見えた", "видели": "見えた",
    "пошел": "行った", "пошла": "行った", "пошло": "行った", "пошли": "行った", "шел": "行った", "шёл": "行った", "шла": "行った", "шло": "行った", "шли": "行った",
    "узнал": "知った", "узнала": "知った", "узнало": "知った", "узнали": "知った",
    "подумал": "思った", "подумала": "思った", "подумало": "思った", "подумали": "思った", "думал": "思った", "думала": "思った", "думало": "思った", "думали": "思った",
    "хотел": "欲しかった", "хотела": "欲しかった", "хотело": "欲しかった", "хотели": "欲しかった",
    "любил": "愛してた", "любила": "愛してた", "любили": "愛してた",
    "мог": "できた", "могла": "できた", "могло": "できた", "могли": "できた",
    "подождал": "待った", "подождала": "待った", "подождали": "待った", "ждал": "待った", "ждала": "待った", "ждали": "待った",
    "написал": "書いた", "написала": "書いた", "написали": "書いた", "писал": "書いた", "писала": "書いた", "писали": "書いた",
    "прочитал": "読んだ", "прочитала": "読んだ", "прочитали": "読んだ", "читал": "読んだ", "читала": "読んだ", "читали": "読んだ",
    "засмеялся": "笑った", "засмеялась": "笑った", "смеялись": "笑った", "смеялся": "笑った", "смеялась": "笑った",
    "заплакал": "泣いた", "заплакала": "泣いた", "заплакали": "泣いた", "плакал": "泣いた", "плакала": "泣いた", "плакали": "泣いた",
    "поиграл": "遊んだ", "поиграла": "遊んだ", "поиграли": "遊んだ",
    "работал": "働いた", "работала": "働いた", "работали": "働いた",  "играл": "遊んだ", "играла": "遊んだ", "играли": "遊んだ",  "играло": "遊んだ",
    "жил": "生きた", "жила": "生きた", "жило": "生きた", "жили": "生きた",
    "умер": "死んだ", "умерла": "死んだ", "умерло": "死んだ", "умерли": "死んだ",
    "понял": ["分かった", "なるほど"], "поняла": "分かった", "поняли": "分かった",
    "ебал": "クソだ",
    "кончил": ["イった", "射精した", "抜いた", "逝った"], "кончила": ["イった", "射精した", "抜いた", "逝った"], "кончили": ["イった", "射精した", "抜いた", "逝った"], "кончит": ["イく", "射精する", "抜く", "逝く"],
    "трахал": ["ヤった", "ファックした"], "трахала": ["ヤった", "ファックした"], "трахали": ["ヤった", "ファックした"], "трахай": ["ヤれ", "ファックしろ"], "трахайте": ["ヤれ", "ファックしろ"],
    "сосал": ["しゃぶった", "フェラした"], "сосала": ["しゃぶった", "フェラした"], "сосали": ["しゃぶった", "フェラした"], "соси": ["しゃぶれ", "フェラしろ"], "сосите": ["しゃぶれ", "フェラしろ"],
    "дрочил": ["シコった", "オナった"], "дрочила": ["シコった", "オナった"], "дрочили": ["シコった", "オナった"], "дрочи": ["シコれ", "オナれ"],
    "присылать": ["送る", "送信する"], "присылаю": ["送っている", "送信している"], "присылаешь": ["送っている", "送信している"],
    "присылает": ["送っている", "送信している"], "присылаем": ["送っている", "送信している"], "присылаете": ["送っている", "送信している"], 
    "присылают": ["送っている", "送信している"], "присылал": ["送っていた", "送信していた"], "присылала": ["送っていた", "送信していた"],
    "присылали": ["送っていた", "送信していた"], "присылай": ["送って", "送信して"], "присылайте": ["送って", "送信して"],
    "отослать": ["送る", "送信する"], "отошлю": ["送る", "送信する"], "отошлёшь": ["送る", "送信する"], "отошлёт": ["送る", "送信する"],
    "отошлём": ["送る", "送信する"], "отошлёте": ["送る", "送信する"], "отошлют": ["送る", "送信する"], "отослал": ["送った", "送信した"],
    "отослала": ["送った", "送信した"], "отослали": ["送った", "送信した"], "отправь": ["送って", "送信して"], "отправьте": ["送って", "送信して"],
    "загружать": ["アップロードする", "読み込む"], "загружаю": ["アップロードしている", "読み込んでいる"], "загружаешь": ["アップロードしている", "読み込んでいる"],
    "загружает": ["アップロードしている", "読み込んでいる"], "загружаем": ["アップロードしている", "読み込んでいる"], "загружаете": ["アップロードしている", "読み込んでいる"],
    "загружают": ["アップロードしている", "読み込んでいる"], "загружал": ["アップロードしていた", "読み込んでいた"], "загружала": ["アップロードしていた", "読み込んでいた"],
    "загружали": ["アップロードしていた", "読み込んでいた"], "загружай": ["アップロードして", "読み込んで"], "загружайте": ["アップロードして", "読み込んで"],
    "загрузить": ["アップロードする", "読み込む"], "загружу": ["アップロードする", "読み込む"], "загрузишь": ["アップロードする", "読み込む"], 
    "загрузит": ["アップロードする", "読み込む"], "загрузим": ["アップロードする", "読み込む"], "загрузите": ["アップロードする", "読み込む"], 
    "загрузят": ["アップロードする", "読み込む"], "загрузил": ["アップロードした", "読み込んだ"], "загрузила": ["アップロードした", "読み込んだ"],
    "загрузили": ["アップロードした", "読み込んだ"], "загрузи": ["アップロードして", "読み込んで"], "загрузите": ["アップロードして", "読み込んで"],
    "скачивать": ["ダウンロードする"], "скачиваю": ["ダウンロードしている"], "скачиваешь": ["ダウンロードしている"], "скачивает": ["ダウンロードしている"], 
    "скачиваем": ["ダウンロードしている"], "скачиваете": ["ダウンロードしている"], "скачивают": ["ダウンロードしている"], "скачивал": ["ダウンロードしていた"],
    "скачивала": ["ダウンロードしていた"], "скачивали": ["ダウンロードしていた"], "скачивай": ["ダウンロードして"], "скачивайте": ["ダウンロードして"],
    "скачать": ["ダウンロードする"], "скачаю": ["ダウンロードする"], "скачаешь": ["ダウンロードする"], "скачает": ["ダウンロードする"],
    "скачаем": ["ダウンロードする"], "скачаете": ["ダウンロードする"], "скачают": ["ダウンロードする"], "скачал": ["ダウンロードした"], 
    "скачала": ["ダウンロードした"], "скачали": ["ダウンロードした"], "скачай": ["ダウンロードして"], "скачайте": ["ダウンロードして"],
    "постить": ["投稿する", "ポストする"], "пощу": ["投稿している", "ポストしている"], "постишь": ["投稿している", "ポストしている"], 
    "постит": ["投稿している", "ポストしている"], "постим": ["投稿している", "ポストしている"], "постите": ["投稿している", "ポストしている"],
    "постят": ["投稿している", "ポストしている"], "постил": ["投稿していた", "ポストしていた"], "постила": ["投稿していた", "ポストしていた"],
    "постили": ["投稿していた", "ポストしていた"], "пость": ["投稿して", "ポストして"], "постите": ["投稿して", "ポストして"],
    "запостить": ["投稿する", "ポストする"], "запощу": ["投稿する", "ポストする"], "запостишь": ["投稿する", "ポストする"], 
    "запостит": ["投稿する", "ポストする"], "запостим": ["投稿する", "ポストする"], "запостите": ["投稿する", "ポストする"],
    "запостят": ["投稿する", "ポストする"], "запостил": ["投稿した", "ポストした"], "запостила": ["投稿した", "ポストした"], 
    "запостили": ["投稿した", "ポストした"], "запость": ["投稿して", "ポストして"], "запостите": ["投稿して", "ポストして"],
    "удалять": ["削除する", "消す"], "удаляю": ["削除している", "消している"], "удаляешь": ["削除している", "消している"], 
    "удаляет": ["削除している", "消している"], "удаляем": ["削除している", "消している"], "удаляете": ["削除している", "消している"], 
    "удаляют": ["削除している", "消している"], "удалял": ["削除していた", "消していた"], "удаляла": ["削除していた", "消していた"],
    "удаляли": ["削除していた", "消していた"], "удаляй": ["削除して", "消して"], "удаляйте": ["削除して", "消して"],
    "удалить": ["削除する", "消す"], "удалю": ["削除する", "消す"], "удалишь": ["削除する", "消す"], "удалит": ["削除する", "消す"], 
    "удалим": ["削除する", "消す"], "удалите": ["削除する", "消す"], "удалят": ["削除する", "消す"], "удалил": ["削除した", "消した"],
    "удалила": ["削除した", "消した"], "удалили": ["削除した", "消した"], "удали": ["削除して", "消して"], "удалите": ["削除して", "消して"],
    
    # --- Прилагательные и Наречия (Adjectives & Adverbs) ---
    "новая": "新しい", "новое": "新しい", "новые": "新しい",
    "старая": "古い", "старое": "古い", "старые": "古い",
    "древняя": "古代の", "древнее": "古代の", "древние": "古代の",
    "молодая": "若い", "молодое": "若い", "молодые": "若い",
    "большая": "大きい", "большое": "大きい", "большие": "大きい",
    "маленькая": "小さい", "маленькое": "小さい", "маленькие": "小さい",
    "высокая": "高い", "высокое": "高い", "высокие": "高い",
    "низкая": "低い", "низкое": "低い", "низкие": "低い",
    "хорошая": "良い", "хорошее": "良い", "хорошие": "良い", "хорошо": "良く",
    "плохая": "悪い", "плохое": "悪い", "плохие": "悪い", "плохо": "悪く",
    "красивая": "美しい", "красивое": "美しい", "красивые": "美しい", "красиво": "美しく",
    "милая": "可愛い", "милое": "可愛い", "милые": "可愛い", "мило": "可愛く",
    "ужасная": "酷い", "ужасное": "酷い", "ужасные": "酷い", "ужасно": "酷く",
    "страшная": "怖い", "страшное": "怖い", "страшные": "怖い", "страшно": "怖く",
    "веселая": "楽しい", "веселое": "楽しい", "веселые": "楽しい", "весело": "楽しく",
    "грустная": "悲しい", "грустное": "悲しい", "грустные": "悲しい", "грустно": "悲しく",
    "интересная": "面白い", "интересное": "面白い", "интересные": "面白い", "интересно": "面白く",
    "скучная": "つまらない", "скучное": "つまらない", "скучные": "つまらない", "скучно": "つまらなく",
    "глупая": "馬鹿な", "глупое": "馬鹿な", "глупые": "馬鹿な", "глупо": "馬鹿に",
    "умная": "賢い", "умное": "賢い", "умные": "賢い", "умно": "賢く",
    "сильная": "強い", "сильное": "強い", "сильные": "強い", "сильно": "強く",
    "слабая": "弱い", "слабое": "弱い", "слабые": "弱い", "слабо": "弱く",
    "крутая": ["すごい", "かっこいい", "ヤバい"], "крутое": ["すごい", "かっこいい", "ヤバい"], "крутые": ["すごい", "かっこいい", "ヤバい"], "круто": ["すごい", "かっこいい", "ヤバい"],
    "странная": "変な", "странное": "変な", "странные": "変な", "странно": "変に",
    "горячая": "熱い", "горячее": "熱い", "горячие": "熱い", "горячо": "熱く",
    "холодная": "冷たい", "холодное": "冷たい", "холодные": "冷たい", "холодно": "冷たく",
    "быстрая": "速い", "быстрое": "速い", "быстрые": "速い", "быстро": "速く",
    "медленная": "遅い", "медленное": "遅い", "медленные": "遅い", "медленно": "遅く",
    "легкая": "簡単な", "легкое": "簡単な", "легкие": "簡単な", "легко": "簡単に",
    "сложная": "難しい", "сложное": "難しい", "сложные": "難しい", "сложно": "難しく",
    "громкая": "うるさい", "громкое": "うるさい", "громкие": "うるさい", "громко": "うるさく",
    "тихая": "静かな", "тихое": "静かな", "тихие": "静かな", "тихо": "静かに",
    
    # --- Мат и грубости (Swear & Rude words) ---
    "блять": ["くそ", "ちくしょう", "畜生", "チクショウ！"], "жопой": ["ケツで", "けつで"], "попой": "お尻で", "попкой": "お尻で", "сракой": "お尻で",
    "нахуй": ["クソ！", "チクショウ！", "くたばれ！", "ちくしょう"], "хуем": ["ちんこで", "ちんぽで", "野郎で", "チソポで"], "хуями": "ディックスで",
    "пиздец": ["やばい", "マジかよ", "最悪だ", "終わってる", "チクショウ！", "やばい", "最悪だ"], "пиздежом": ["デタラメで", "出鱈目で", "嘘八百で", "嘘八百で", "たわごとで"], "пиздёжом": ["デタラメで", "出鱈目で", "嘘八百で", "嘘八百で", "たわごとで"],
    "хуй": ["ちんこ", "ちんぽ", "野郎", "チソポ"], "хуи": "ディックス", "пиздеж": ["デタラメ", "出鱈目", "嘘八百", "嘘八百", "たわごと"], "пиздёж": ["デタラメ", "出鱈目", "嘘八百", "嘘八百", "たわごと"], "пиздежу": ["デタラメ", "出鱈目", "嘘八百", "嘘八百", "たわごと"], "пиздёжа": ["デタラメ", "出鱈目", "嘘八百", "嘘八百", "たわごと"],
    "пидор": ["ホモ", "おかま", "ゲイ", "ホモ野郎"], "пидоры": ["ホモ", "おかま", "ゲイ", "ホモ野郎"], "пидору": ["ホモ", "おかま", "ゲイ", "ホモ野郎"], "пидорам": ["ホモ", "おかま", "ゲイ", "ホモ野郎"], "пидором": ["ホモで", "おかまで", "ゲイで", "ホモ野郎で"],
    "сука": ["雌犬", "あばずれ", "この野郎", "やばい", "最悪だ"], "сиськи": "おっぱい",  "суки": ["雌犬", "あばずれ", "この野郎"], "сиська": "おっぱい", "сук": ["雌犬", "あばずれ", "この野郎"],
    "говно": ["うんこ", "クソ", "糞"], "долбаёб": "バカ", "говна": ["うんこ", "クソ", "糞"], "долбаёба": "バカ",  "говну": ["うんこ", "クソ", "糞"], "долбаёбу": "バカ",
    "дерьмо": ["うんこ", "クソ", "糞", "クソ！", "チクショウ！", "くたばれ！", "ちくしょう"], "долбоеб": "バカ", "дерьму": ["うんこ", "クソ", "糞"], "долбоебу": "バカ", "долбоеба": "バカ",
    "хуйня": ["うんこ", "クソ", "糞", "やばい", "最悪だ"], "хуйней": ["うんこ", "クソ", "糞", "やばい", "最悪だ"], "хуйнёй": ["うんこ", "クソ", "糞", "やばい", "最悪だ"], "долбоёб": "バカ", "хуйни": ["うんこ", "クソ", "糞"], "долбоёбу": "バカ", "долбоёба": "バカ", "хуйню": ["うんこ", "クソ", "糞"],
    "ебать": ["気が狂う", "クソ", "クソ！", "チクショウ！", "くたばれ！", "ちくしょう", "マジか", "信じられない"], "еблан": "バカ", "анал": "肛門", "ебланы": "クソ野郎ども",  "долбаёбы": "バカ者", "долбоебы": ["馬鹿共", "アホども", "馬鹿野郎ども", "トンチキども"],
    "хуета": ["うんこ", "クソ", "糞"], "долбаеб": "バカ", "ебанат": "バカ", "долбаебы": "バカ者", "ебанаты": "バカ者", "хуете": ["うんこ", "クソ", "糞"], "хуету": ["うんこ", "クソ", "糞"],
    "пизда": ["女性器", "プッシー", "まんこ", "やばい", "最悪だ"], "ебануться": "気が狂う", "даун": "埋もれよ", "пизде": ["女性器", "プッシー", "まんこ"], "пизду": ["女性器", "プッシー", "まんこ"],
    "жопа": ["ケツ", "けつ"], "попа": "お尻", "попец": "お尻", "срака": "お尻", "мудак": ["ろくでなし", "くそったれ"], "жопе": ["ケツ", "けつ"], "попе": "お尻", "жопу": ["ケツ", "けつ"], "попу": "お尻",
    "идиот": ["馬鹿", "アホ", "馬鹿野郎", "トンチキ"], "очко": "肛門", "анус": "肛門", "хуец": "ちんこ", "попка": "お尻", "идиоты": ["馬鹿共", "アホども", "馬鹿野郎ども", "トンチキども"], "идиотам": ["馬鹿共", "アホども", "馬鹿野郎ども", "トンチキども"],
    "дебил": "低能",  "дебилу": "低能", "дебилы": "低能ども", "дебилам": "低能ども", "урод": "ブス", "уродам": "ブスども", "уроды": "ブスども", "мразь": "クズ", "мрази": "クズども", "мразям": "クズども", "хуйло": "バカ野郎", "отъебись": "ほっといて", "гандон": "低能", "гандону": "低能", "гандоны": "低能ども", "гандонам": "低能ども",
    "заткнись": ["うるさい", "黙れ", "だまれクソ"], "отвали": "ほっといて", "умри": ["死ね", "埋もれよ", "消えろ！", "くたばれ！"], "сдохни": ["死ね", "埋もれよ", "消えろ！", "くたばれ！"], "завались": ["うるさい", "黙れ", "だまれクソ", "くたばれ！"], "завали": ["うるさい", "黙れ", "だまれクソ", "くたばれ！"],


    
# --- Междометия и сленг (Exclamations & Slang) ---
    "вау": ["うわー", "すげー"], "ого": "おお", "воу": ["うわー", "すげー"], "офигеть": ["やべえ", "すげえ"], "ничего себе": ["マジか", "すごい"],
    "упс": "おっと", "черт": "ちぇっ", "блин": ["もう", "しまった"], "бля": ["くそ", "ちくしょう"],
    "жиза": ["それな", "わかる"], "забей": ["気にしないで", "ドンマイ"], "реально": ["マジで", "本当に"], "серьезно": ["マジで", "本気で"],
    "короче": ["とにかく", "要するに"], "типа": ["みたいな", "って感じ"], "кстати": ["ちなみに", "ところで"],
    "ну": ["ええと", "あの"], "нуу": ["ええとー", "あのー"], "нууу": ["ええとーー", "あのーー"], "эм": "うーん", "хм": "ふむ",
    "эй": ["おい", "ねえ"], "хэй": "おい",
    "ага": "うん", "угу": "うん", "окей": ["オッケー", "OK", "了解"], "ок": ["ОК", "了解"],
    "давай": ["じゃあ", "やろう"], "го": ["行こう", "やろう"], "гоу": ["行こうぜ", "やろう"],
    "стоп": ["待って", "ストップ"], "помогите": "助けて", "хелп": "助けて",
    "понял": ["分かった", "了解"], "понятно": "なるほど",
    "печаль": "残念", "беда": "大変だ", "удачи": "頑張って",
}

# Множество местоимений для быстрой проверки
PRONOUNS = {"я", "ты", "вы", "он", "она", "мы", "они", "это", "то"}

# Кавайные аниме-смайлики (С ЭКРАНИРОВАНИЕМ HTML)
KAWAII_EMOJIS = [
    ' (´∀｀) ', ' (￣ω￣) ', ' (◕‿◕) ', escape_html(' (⁄ ⁄>⁄ ▽⁄<⁄ ⁄) '), ' (✿◠‿◠) ',
    ' (◡‿◡✿) ', ' (◕‿-) ', ' (=^･ｪ･^=) ', ' (^・ω・^ ) ', ' (●´ω｀●) ',
    escape_html(' ヾ(≧▽≦*)o '), escape_html(' o((>ω< ))o '), ' (｡･ω･｡) ', escape_html(' (・ω<) '), escape_html(' (づ｡◕‿‿◕｡)づ '),
    escape_html(' (ﾉ◕ヮ◕)ﾉ*:･ﾟ✧ '), ' (●´□`)♡ ', ' (´｡• ω •｡`) ', escape_html(' (っ◕‿◕)っ '), escape_html(' (づ￣ ³￣)づ '),
    escape_html(' (ﾉ>ω<)ﾉ :｡･:*:･ﾟ’★,｡･:*:♪･ﾟ’☆ '), ' (●´ω｀●)ゞ ', ' ✧･ﾟ: *✧･ﾟ:* ',
    ' (●´艸`) ', escape_html(' (✪‿✪)ノ '),
    ' ^_^', ' ^o^', escape_html(' >_<'), ' T_T', ' ;_;', ' :3', ' :D', ' :P', ' :O', ' :*', escape_html(' <3'),
    ' (^_^) ', ' (^o^) ', escape_html(' (>_<) '), ' (T_T) ', ' (;_;) ',
    escape_html(' (｡>﹏<｡) '), ' (¬_¬) ', ' (⌒_⌒;) ', ' (＾▽＾) ', ' (￣ヘ￣) ', escape_html(' (╯°□°）╯︵ ┻━┻ '), ' ヽ(´▽`)/ ',
    ' ¯\\_(ツ)_//¯ ', ' ( ͡° ͜ʖ ͡°) ', escape_html(' (っ˘ω˘ς ) '), ' (´･ω･`) ', ' (＾ω＾) ',
    ' (；一_一) ', ' (´･_･`) ', ' (⊙_◎) ', ' (・_・;) ',
]

# --- Остальные константы без изменений ---
HIRAGANA_MAP = {
    'а': 'あ', 'и': 'い', 'у': 'う', 'э': 'え', 'о': 'お', 'е': 'え', 'ка': 'か', 'ки': 'き', 'ку': 'く', 'кэ': 'け', 'ке': 'け', 'ко': 'こ', 'кя': 'きゃ', 'кю': 'きゅ', 'кё': 'きょ', 'га': 'が', 'ги': 'ぎ', 'гу': 'ぐ', 'гэ': 'げ', 'ге': 'げ', 'го': 'ご', 'гя': 'ぎゃ', 'гю': 'ぎゅ', 'гё': 'ぎょ', 'са': 'さ', 'си': 'し', 'су': 'す', 'сэ': 'せ', 'со': 'そ', 'ся': 'しゃ', 'сю': 'しゅ', 'сё': 'しょ', 'за': 'ざ', 'зи': 'じ', 'зу': 'ず', 'зэ': 'ぜ', 'зо': 'ぞ', 'зя': 'じゃ', 'зю': 'じゅ', 'зё': 'じょ', 'та': 'た', 'ти': 'ち', 'тэ': 'て', 'те': 'て', 'то': 'と', 'цу': 'つ', 'тсу': 'つ', 'тя': 'ちゃ', 'тю': 'ちゅ', 'тё': 'ちょ', 'да': 'だ', 'ди': 'ぢ', 'дэ': 'で', 'де': 'で', 'до': 'ど', 'дзу': 'づ', 'ду': 'づ', 'дя': 'ぢゃ', 'дю': 'ぢゅ', 'дё': 'ぢょ', 'на': 'な', 'ни': 'に', 'ну': 'ぬ', 'нэ': 'ね', 'не': 'ね', 'но': 'の', 'ня': 'にゃ', 'ню': 'にゅ', 'нё': 'にょ', 'ха': 'は', 'хи': 'ひ', 'ху': 'ふ', 'хэ': 'へ', 'хе': 'へ', 'хо': 'ほ', 'хя': 'ひゃ', 'хю': 'ひゅ', 'хё': 'ひょ', 'ба': 'ば', 'би': 'び', 'бу': 'ぶ', 'бэ': 'べ', 'бе': 'べ', 'бо': 'ぼ', 'бя': 'びゃ', 'бю': 'びゅ', 'бё': 'びょ', 'па': 'ぱ', 'пи': 'ぴ', 'пу': 'ぷ', 'пэ': 'ぺ', 'пе': 'ぺ', 'по': 'ぽ', 'пя': 'ぴゃ', 'пю': 'ぴゅ', 'пё': 'ぴょ', 'ма': 'ま', 'ми': 'み', 'му': 'む', 'мэ': 'め', 'ме': 'め', 'мо': 'も', 'мя': 'みゃ', 'мю': 'みゅ', 'мё': 'みょ', 'ра': 'ら', 'ри': 'り', 'ру': 'る', 'рэ': 'れ', 'ре': 'れ', 'ро': 'ろ', 'ря': 'りゃ', 'рю': 'りゅ', 'рё': 'りょ', 'ва': 'わ', 'ви': 'うぃ', 'вэ': 'うぇ', 'во': 'を', 'ве': 'うぇ', 'фа': 'ふぁ', 'фи': 'ふぃ', 'фу': 'ふ', 'фэ': 'ふぇ', 'фо': 'ふぉ', 'йа': 'や', 'йу': 'ゆ', 'йо': 'よ', 'я': 'や', 'ю': 'ゆ', 'ла': 'ら', 'ли': 'り', 'лэ': 'れ', 'ле': 'れ', 'лу': 'る', 'ло': 'ろ', 'ля': 'りゃ', 'лю': 'りゅ', 'лё': 'りょ', 'ща': 'しゃ', 'щу': 'しゅ', 'що': 'しょ', 'ще': 'しぇ', 'щэ': 'しぇ', 'ча': 'ちゃ', 'чу': 'ちゅ', 'чо': 'ちょ', 'че': 'ちぇ', 'ц': 'つ', 'ца': 'つぁ', 'цо': 'つぉ', 'це': 'つぇ', 'цы': 'つぃ', 'цю': 'つゅ', 'цэ': 'つぇ', 'ж': 'じ', 'жа': 'じゃ', 'же': 'じぇ', 'жи': 'じ', 'жо': 'じょ', 'жу': 'じゅ', 'жэ': 'じぇ', 'ш': 'し', 'ша': 'しゃ', 'ше': 'しぇ', 'ши': 'し', 'шо': 'しょ', 'шу': 'しゅ', 'й': 'い', 'ь': '', 'ъ': '', 'ы': 'い', 'йи': 'い', 'йы': 'い', 'в': 'ゔ', 'ва': 'ゔぁ', 'ве': 'ゔぇ', 'ви': 'ゔぃ', 'во': 'ゔぉ', 'ву': 'ゔ', 'дж': 'ぢ', 'дз': 'づ', 'джа': 'ぢゃ', 'дже': 'ぢぇ', 'джо': 'ぢょ', 'джу': 'ぢゅ', 'кс': 'くす', 'гз': 'ぐず', 'кв': 'くゔ', 'тс': 'つ', 'тьс': 'つ', 'нь': 'ん', 'рр': 'っら', 'сс': 'っさ', 'тт': 'った', 'пп': 'っぱ', 'йе': 'いぇ', 'йэ': 'いぇ', 'йё': 'いよ', 'йя': 'いや', 'тр': 'とら', 'др': 'どら', 'стр': 'すとら', 'кр': 'くら', 'гр': 'ぐら', 'пр': 'ぷら', 'бр': 'ぶら', 'фр': 'ふら', 'вр': 'ゔら', 'зр': 'ずら', 'кл': 'くら', 'гл': 'ぐら', 'пл': 'ぷら', 'бл': 'ぶら', 'фл': 'ふら', 'вл': 'ゔら', 'сл': 'すら', 'зл': 'ずら', 'тл': 'とら', 'дл': 'どら', 'кт': 'くと', 'гт': 'ぐと', 'пт': 'ぷと', 'бт': 'ぶと', 'фт': 'ふと', 'вт': 'ゔと', 'ст': 'すと', 'зт': 'ずと', 'хт': 'ひと', 'цт': 'つと', 'чт': 'ちと', 'шт': 'しと', 'щт': 'しと', 'ск': 'すく', 'зк': 'ずく', 'б': 'ぶ', 'в': 'ゔ', 'г': 'ぐ', 'д': 'ど', 'ж': 'じ', 'з': 'ず', 'к': 'く', 'л': 'る', 'м': 'む', 'н': 'ん', 'п': 'ぷ', 'р': 'ら', 'с': 'す', 'т': 'と', 'ф': 'ふ', 'х': 'ひ', 'ц': 'つ', 'ч': 'ち', 'ш': 'し', 'щ': 'し', 'ё': 'よ'
}
KATAKANA_MAP = {
    'а': 'ア', 'и': 'イ', 'у': 'ウ', 'э': 'エ', 'о': 'オ', 'е': 'エ', 'ка': 'カ', 'ки': 'キ', 'ку': 'ク', 'кэ': 'ケ', 'ко': 'コ', 'ке': 'ケ', 'кя': 'キャ', 'кю': 'キュ', 'кё': 'キョ', 'га': 'ガ', 'ги': 'ギ', 'гу': 'グ', 'гэ': 'ゲ', 'го': 'ゴ', 'ге': 'ゲ', 'гя': 'ギャ', 'гю': 'ギュ', 'гё': 'ギョ', 'са': 'サ', 'си': 'シ', 'су': 'ス', 'сэ': 'セ', 'со': 'ソ', 'се': 'セ', 'ся': 'シャ', 'сю': 'シュ', 'сё': 'ショ', 'за': 'ザ', 'зи': 'ジ', 'зу': 'ズ', 'зэ': 'ゼ', 'зо': 'ゾ', 'зе': 'ゼ', 'зя': 'ジャ', 'зю': 'ジュ', 'зё': 'ジョ', 'та': 'タ', 'ти': 'チ', 'тэ': 'テ', 'то': 'ト', 'цу': 'ツ', 'те': 'テ', 'тя': 'チャ', 'тю': 'チュ', 'тё': 'チョ', 'да': 'ダ', 'ди': 'ヂ', 'дэ': 'デ', 'до': 'ド', 'дзу': 'ヅ', 'де': 'デ', 'дя': 'ヂャ', 'дю': 'ヂュ', 'дё': 'ヂョ', 'на': 'ナ', 'ни': 'ニ', 'ну': 'ヌ', 'нэ': 'ネ', 'но': 'ノ', 'не': 'ネ', 'ня': 'ニャ', 'ню': 'ニュ', 'нё': 'ニョ', 'ха': 'ハ', 'хи': 'ヒ', 'ху': 'フ', 'хэ': 'ヘ', 'хо': 'ホ', 'хе': 'ヘ', 'хя': 'ヒャ', 'хю': 'ヒュ', 'хё': 'ヒョ', 'ба': 'バ', 'би': 'ビ', 'бу': 'ブ', 'бэ': 'ベ', 'бо': 'ボ', 'бе': 'ベ', 'бя': 'ビャ', 'бю': 'ビュ', 'бё': 'ビョ', 'па': 'パ', 'пи': 'ピ', 'пу': 'プ', 'пэ': 'ペ', 'по': 'ポ', 'пе': 'ペ', 'пя': 'ピャ', 'пю': 'ピュ', 'пё': 'ピョ', 'ма': 'マ', 'ми': 'ミ', 'му': 'ム', 'мэ': 'メ', 'мо': 'モ', 'ме': 'メ', 'мя': 'ミャ', 'мю': 'ミュ', 'мё': 'ミョ', 'ра': 'ラ', 'ри': 'リ', 'ру': 'ル', 'рэ': 'レ', 'ро': 'ロ', 'ре': 'レ', 'ря': 'リャ', 'рю': 'リュ', 'рё': 'リョ', 'ва': 'ワ', 'ви': 'ウィ', 'вэ': 'ウェ', 'во': 'ヲ', 'фа': 'ファ', 'фи': 'フィ', 'фу': 'フ', 'фэ': 'フェ', 'фо': 'フォ', 'фе': 'フェ', 'йа': 'ヤ', 'йу': 'ユ', 'йо': 'ヨ', 'я': 'ヤ', 'ю': 'ユ', 'ла': 'ラ', 'ли': 'リ', 'лэ': 'レ', 'ле': 'レ', 'лу': 'ル', 'ло': 'ロ', 'ля': 'リャ', 'лю': 'リュ', 'лё': 'リョ', 'ща': 'シャ', 'щу': 'シュ', 'що': 'ショ', 'ще': 'シェ', 'ча': 'チャ', 'чу': 'チュ', 'чо': 'チョ', 'че': 'チェ', 'ц': 'ツ', 'ца': 'ツァ', 'цо': 'ツォ', 'це': 'ツェ', 'цы': 'ツィ', 'цю': 'ツュ', 'ж': 'ジ', 'жа': 'ジャ', 'же': 'ジェ', 'жи': 'ジ', 'жо': 'ジョ', 'жу': 'ジュ', 'ш': 'シ', 'ша': 'シャ', 'ше': 'シェ', 'ши': 'シ', 'шо': 'ショ', 'шу': 'シュ', 'й': 'イ', 'ь': '', 'ъ': '', 'ы': 'イ', 'йи': 'イ', 'йы': 'イ', 'в': 'ヴ', 'ва': 'ヴァ', 'ве': 'ヴェ', 'ви': 'ヴィ', 'во': 'ヴォ', 'ву': 'ヴ', 'дж': 'ヂ', 'дз': 'ヅ', 'джа': 'ヂャ', 'дже': 'ヂェ', 'джо': 'ヂョ', 'джу': 'ヂュ', 'кс': 'クス', 'гз': 'グズ', 'кв': 'クヴ', 'тс': 'ツ', 'тьс': 'ツ', 'нь': 'ン', 'рр': 'ッラ', 'сс': 'ッサ', 'тт': 'ッタ', 'пп': 'ッパ', 'йе': 'イェ', 'йэ': 'イェ', 'йё': 'イヨ', 'йя': 'イヤ', 'б': 'ブ', 'в': 'ヴ', 'г': 'グ', 'д': 'ド', 'ж': 'ジ', 'з': 'ズ', 'к': 'ク', 'л': 'ル', 'м': 'ム', 'н': 'ン', 'п': 'プ', 'р': 'ラ', 'с': 'ス', 'т': 'ト', 'ф': 'フ', 'х': 'ヒ', 'ц': 'ツ', 'ч': 'チ', 'ш': 'シ', 'щ': 'シ', 'ё': 'ヨ'
}
NUMERALS = {0: '零', 1: '一', 2: '二', 3: '三', 4: '四', 5: '五', 6: '六', 7: '七', 8: '八', 9: '九', 10: '十', 100: '百', 1000: '千', 10000: '万', 100000000: '億', 1000000000000: '兆'}
PARTICLES = ['ね', 'よ', 'か', 'わ', 'の', 'な', 'ぞ', 'ぜ', 'が', 'に', 'で', 'と', 'も', 'や', 'さ', 'かしら', 'とも', 'って', 'たら', 'のに', 'ので', 'から', 'し', 'こと']
NYA_INTERJECTIONS = ['にゃあ', 'にゃん', 'にゃーん', 'にゃお', 'みゃあ', 'にゃっ', 'にゃんにゃん', 'にゃー', 'にゃんぱすー']
END_PHRASES = ['です', 'ですね', 'ですよ', 'ですわ', 'なのです', 'かもしれません', 'でしょう', 'だろう', 'かもね', 'に違いない', 'に決まってる', 'だと思う', 'かな', 'なんだよね', 'ってこと', 'わけ', 'はず', 'みたい', 'そう', 'らしい', 'ようだ', 'みたいだ', '感じ', '気がする']

def convert_number(num_str):
    try:
        num = int(num_str)
        if num >= 10**16: return num_str
        if num == 0: return NUMERALS[0]
        result, units = [], [1000000000000, 100000000, 10000, 1000, 100, 10, 1]
        for unit in units:
            if num < unit: continue
            count, num = divmod(num, unit)
            if count > 1 or unit == 1:
                result.append(convert_number(str(count)) if count >= 10 else NUMERALS[count])
            if unit > 1: result.append(NUMERALS[unit])
        return ''.join(result)
    except Exception: return num_str

def transliterate_word(word, kana_map):
    word = re.sub(r'ться$', 'тсу', word)
    word = re.sub(r'тся$', 'тса', word)
    word = re.sub(r'([бвгджзйклмнпрстфхцчшщ])\1', lambda m: ('っ' if kana_map is HIRAGANA_MAP else 'ッ') + m.group(1), word)
    word = re.sub(r'([бвгджзйклмнпрстфхцчшщ])ь([ауоыэеёюяи])', lambda m: m.group(1) + {'а': 'я', 'у': 'ю', 'о': 'ё', 'э': 'е', 'е': 'е', 'ы': 'и', 'ё': 'ё', 'ю': 'ю', 'я': 'я', 'и': 'и'}[m.group(2)], word)
    result = []
    while word:
        found = False
        for length in range(min(3, len(word)), 0, -1):
            syllable = word[:length]
            if syllable in kana_map:
                result.append(kana_map[syllable])
                word = word[length:]
                found = True
                break
        if not found:
            result.append(word[0])
            word = word[1:]
    return ''.join(result)

def to_kana(text, kana_map):
    tokens = re.findall(r'[\w-]+|[^\w\s-]', text.lower())
    result = []
    for token in tokens:
        if token.isdigit():
            result.append(convert_number(token))
        elif re.match(r'^[a-zA-Zа-яА-ЯёЁ-]+$', token):
            result.append(transliterate_word(token, kana_map))
        else:
            result.append(token)
    return ''.join(result)


def anime_transform(text):
    """Гибридная функция преобразования в аниме-стиль с улучшенной грамматикой и обработкой смеха."""
    if not text.strip():
        return text

    # --- ИЗМЕНЕНИЕ: Предварительная обработка смеха ---
    # Паттерн для поиска повторяющихся "ах", "ха", "хв" и т.д. длиной 4+ символов
    laugh_pattern = r'([ахвхвaхвхв]+[ахвхвaхвхв]{3,})'
    japanese_laughs = ["草", "www", "（笑）", "www草", "大草原"]
    text = re.sub(laugh_pattern, lambda m: random.choice(japanese_laughs), text, flags=re.IGNORECASE)

    words = text.split(' ')
    transformed_words = []
    kana_map = random.choice([HIRAGANA_MAP, KATAKANA_MAP])

    for word in words:
        if not word: continue
        
        match = re.match(r'^(.+?)([.,!?;:]+)$', word)
        if match:
            clean_word, punctuation = match.groups()
        else:
            clean_word, punctuation = word, ''
        base_word = clean_word.lower()

        if base_word in JAPANESE_WORD_REPLACEMENTS:
            translation = JAPANESE_WORD_REPLACEMENTS[base_word]
            translated_word = random.choice(translation) if isinstance(translation, list) else translation
            
            if base_word in PRONOUNS:
                if random.random() < 0.7:
                    translated_word += 'は'
                else:
                    translated_word += 'が'
            
            transformed_words.append(translated_word + punctuation)
        else:
            transliterated_word = to_kana(clean_word, kana_map)
            transformed_words.append(transliterated_word + punctuation)

    final_words = []
    for word in transformed_words:
        final_words.append(word)
        if random.random() < 0.15:
            final_words[-1] += random.choice(PARTICLES)
        if random.random() < 0.10:
            final_words[-1] += random.choice(NYA_INTERJECTIONS)
        if random.random() < 0.08:
            final_words.append(random.choice(KAWAII_EMOJIS).strip())

    result = ' '.join(final_words)

    if random.random() < 0.35:
        result += random.choice(END_PHRASES)

    if random.random() < 0.5:
        result += random.choice(KAWAII_EMOJIS)
        
    return result.strip()


async def get_random_anime_image():
    """
    Получает URL случайной аниме-картинки с нескольких API.
    С вероятностью 10% пытается получить GIF-анимацию.
    С вероятностью 25% пытается получить NSFW контент.
    Автоматически переключается на следующий источник в случае ошибки.
    """
    is_nsfw_request = random.random() < 0.25
    is_gif_request = random.random() < 0.1

    apis = []
    
    if is_gif_request:
        print(f"[ANIME DEBUG] Attempting to fetch a GIF (NSFW: {is_nsfw_request})...")
        if is_nsfw_request:
            # --- НАЧАЛО ИЗМЕНЕНИЙ: Расширенный список NSFW GIF категорий ---
            apis = [
                # waifu.pics имеет разнообразные NSFW GIF категории
                {"url": f"https://api.waifu.pics/nsfw/{random.choice(['blowjob'])}", "source": "waifu.pics (nsfw-gif)"},
                # nekos.best в основном сфокусирован на определенных действиях
                {"url": f"https://nekos.best/api/v2/{random.choice(['cum', 'bJ'])}", "source": "nekos.best (nsfw-gif)"}
            ]
            # --- КОНЕЦ ИЗМЕНЕНИЙ ---
        else:
            # SFW GIF категории
            apis = [
                {"url": f"https://api.waifu.pics/sfw/{random.choice(['dance', 'wave', 'blush', 'bonk', 'smile', 'highfive'])}", "source": "waifu.pics (sfw-gif)"},
                {"url": f"https://nekos.best/api/v2/{random.choice(['cuddle', 'pat', 'baka', 'blush', 'slap', 'wink'])}", "source": "nekos.best (sfw-gif)"}
            ]
    else:
        print(f"[ANIME DEBUG] Attempting to fetch a static image (NSFW: {is_nsfw_request})...")
        if is_nsfw_request:
            # --- НАЧАЛО ИЗМЕНЕНИЙ: Расширенный список NSFW Static категорий ---
            apis = [
                # waifu.pics имеет две основные категории для NSFW изображений
                {"url": f"https://api.waifu.pics/nsfw/{random.choice(['waifu', 'neko'])}", "source": "waifu.pics (nsfw-static)"},
                # nekos.best предлагает более широкий выбор статических NSFW тегов
                {"url": f"https://nekos.best/api/v2/{random.choice(['pussy', 'neko', 'feet', 'yuri', 'cum', 'erofeet', 'blowjob', 'lewd'])}", "source": "nekos.best (nsfw-static)"}
            ]
            # --- КОНЕЦ ИЗМЕНЕНИЙ ---
        else:
            # SFW Static категории
            apis = [
                {"url": "https://api.waifu.pics/sfw/waifu", "source": "waifu.pics (sfw-static)"},
                {"url": "https://nekos.best/api/v2/waifu", "source": "nekos.best (sfw-static)"}
            ]

    random.shuffle(apis)

    async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=4)) as session:
        for api in apis:
            try:
                async with session.get(api["url"]) as response:
                    if response.status != 200:
                        print(f"[{api['source']}] API Error: Status {response.status}")
                        continue

                    data = await response.json()
                    image_url = None

                    if "waifu.pics" in api["source"]:
                        if data and 'url' in data:
                            image_url = data['url']
                    elif "nekos.best" in api["source"]:
                        if data and 'results' in data and data['results']:
                            image_url = data['results'][0]['url']
                    
                    if image_url and image_url.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.webp')):
                        print(f"[{api['source']}] Image received: {image_url}")
                        return image_url
                    else:
                        print(f"[{api['source']}] Invalid image URL or format: {image_url}")

            except Exception as e:
                print(f"[{api['source']}] Request failed: {e}")
                continue
    
    print("⛔ All random image APIs failed to provide an image.")
    return None
    
async def get_monogatari_image():
    """
    Получает URL случайной картинки из серии Monogatari.
    С вероятностью 25% ищет NSFW (questionable, explicit) контент.
    Использует Danbooru (с аутентификацией, если возможно) как основной источник
    и другие API как резервные.
    """
    apis = [
        {"type": "danbooru", "source": "Danbooru"},
        {"type": "fallback", "url": "https://api.waifu.pics/sfw/waifu", "source": "waifu.pics (fallback)"},
        {"type": "fallback", "url": "https://nekos.best/api/v2/waifu", "source": "nekos.best (fallback)"}
    ]
    random.shuffle(apis)

    headers = {
        'User-Agent': 'DvachChatBot/1.0 (by ShlomaPetia on Telegram)'
    }
    
    if random.random() < 0.25:
        rating_tag = random.choice(['rating:questionable', 'rating:explicit'])
        print(f"[Danbooru API] Attempting to fetch NSFW Monogatari image with tag: {rating_tag}.")
    else:
        rating_tag = 'rating:safe'
        print("[Danbooru API] Attempting to fetch SFW Monogatari image.")
        
    # --- НАЧАЛО ИЗМЕНЕНИЙ: Переход на мета-тег order:random ---
    params_danbooru = {
        # Добавляем order:random для получения случайного поста
        'tags': f'monogatari_series {rating_tag} order:random',
        'limit': 1 # Для order:random рекомендуется limit=1
    }
    # --- КОНЕЦ ИЗМЕНЕНИЙ ---
    
    danbooru_user = os.getenv("DANBOORU_USERNAME")
    danbooru_key = os.getenv("DANBOORU_API_KEY")

    if danbooru_user and danbooru_key:
        params_danbooru['login'] = danbooru_user
        params_danbooru['api_key'] = danbooru_key
        print("[Danbooru API] Using authenticated request.")
    else:
        print("[Danbooru API] WARNING: Using anonymous request. May be unstable or return empty results.")

    async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=8)) as session:
        for api in apis:
            try:
                image_url = None
                if api["type"] == "danbooru":
                    async with session.get("https://danbooru.donmai.us/posts.json", params=params_danbooru, headers=headers) as response:
                        if response.status != 200:
                            print(f"[{api['source']}] API Error: Status {response.status}")
                            continue

                        data = await response.json()
                        if not data or not isinstance(data, list):
                            print(f"[{api['source']}] Error: Empty or invalid response.")
                            continue
                        
                        # --- НАЧАЛО ИЗМЕНЕНИЙ: Упрощенная обработка ответа ---
                        # Так как limit=1, мы просто берем первый (и единственный) пост
                        selected_post = data[0]
                        if 'file_url' in selected_post and selected_post['file_url'].lower().endswith(('.png', '.jpg', '.jpeg')):
                            image_url = selected_post['file_url']
                        else:
                            print(f"[{api['source']}] No valid image found in the response post.")
                            continue
                        # --- КОНЕЦ ИЗМЕНЕНИЙ ---

                else: # Логика для резервных API (она всегда SFW)
                    async with session.get(api["url"]) as response:
                        if response.status != 200:
                            print(f"[{api['source']}] API Error: Status {response.status}")
                            continue

                        data = await response.json()
                        
                        if "waifu.pics" in api["source"]:
                            if data and 'url' in data:
                                image_url = data['url']
                        elif "nekos.best" in api["source"]:
                            if data and 'results' in data and data['results']:
                                image_url = data['results'][0]['url']

                if image_url and image_url.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.webp')):
                    print(f"[{api['source']}] Image received: {image_url}")
                    return image_url
                else:
                    if image_url is not None:
                        print(f"[{api['source']}] Invalid image URL or format: {image_url}")
                    continue

            except Exception as e:
                print(f"[{api['source']}] Request failed: {e}")
                continue
    
    print("⛔ All Monogatari-related and fallback APIs failed to provide an image.")
    return None
