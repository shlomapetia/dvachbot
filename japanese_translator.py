# japanese_translator.py
import random
import re
import aiohttp
from aiohttp import ClientTimeout

# --- НОВЫЙ СУЩЕСТВЕННО РАСШИРЕННЫЙ СЛОВАРЬ ПЕРЕВОДОВ ---
JAPANESE_WORD_REPLACEMENTS = {
    # --- Местоимения (Pronouns) ---
    "я": ["私", "俺", "僕", "わたくし"],
    "ты": ["君", "お前", "あなた"],
    "вы": ["あなた", "君たち", "お前ら"],
    "он": ["彼", "あいつ"],
    "она": ["彼女", "あの子"],
    "оно": "それ",
    "мы": ["私達", "我々"],
    "они": ["彼ら", "あいつら"],
    "это": ["これ", "それ"], "то": "あれ", "себя": "自分", "мой": "私の", "твой": "君の", "наш": "私達の", "ваш": "あなたたちの",

    # --- Вопросительные слова (Question Words) ---
    "кто": "誰", "что": ["何", "何が"], "где": "どこ", "когда": "いつ", "почему": ["なぜ", "どうして"], "как": "どう", "какой": "どの", "сколько": "いくつ", "чей": "誰の",

    # --- Частотные слова и частицы (Common words & Particles) ---
    "да": ["はい", "うん", "ええ", "そう"],
    "нет": ["いいえ", "いや", "ううん"],
    "привет": ["こんにちは", "やあ", "どうも", "ハロー"],
    "пока": ["じゃあね", "またね", "バイバイ", "失礼します"],
    "спасибо": ["ありがとう", "どうも", "ありがとうございます"],
    "пожалуйста": ["どうぞ", "お願いします"],
    "извини": ["ごめん", "ごめんなさい", "すみません"],
    "хорошо": ["良い", "いい", "結構", "大丈夫"],
    "плохо": ["悪い", "ダメ", "良くない"],
    "очень": ["とても", "すごく", "めっちゃ", "超"],
    "тоже": "も", "еще": "もっと", "уже": "もう", "конечно": "もちろん", "просто": "ただ",
    "человек": ["人", "人間"], "люди": "人々", "друг": ["友達", "友人"], "враг": "敵", "парень": "彼氏", "девушка": "彼女",
    "бог": "神", "жизнь": "人生", "смерть": "死", "любовь": "愛", "ненависть": "憎しみ",
    "день": "日", "ночь": "夜", "утро": "朝", "вечер": "夕方",
    "сегодня": "今日", "вчера": "昨日", "завтра": "明日",
    "дом": "家", "школа": "学校", "работа": "仕事", "страна": "国", "город": "町", "мир": "世界",

# --- Интернет и общение (Internet & Communication) ---
    "лол": ["笑", "(笑)", "www", "草"], "кек": "草", "рофл": "冗談", "рофлить": "冗談を言う",
    "пост": ["投稿", "ポスト", "スレ"], "тред": "スレ", "коммент": "コメント", "ответ": "返信", "реплай": "リプライ",
    "админ": ["管理人", "管理者", "アドミン"], "модер": "モデレーター", "бан": ["バン", "垢BAN"], "забанить": "バンする",
    "бот": "ボット", "ник": ["ニックネーム", "ハンドルネーム"], "аватар": "アイコン",
    "чат": "チャット", "дискорд": "ディスコ", "телеграм": "テレグラム", "тг": "テレグラム",
    "сообщение": "メッセージ", "текст": ["テキスト", "文章"], "голосовое": "ボイスメッセージ", "гс": "ボイスメッセージ",
    "картинка": "画像", "пикча": "画像", "видео": "動画", "видос": "動画", "ссылка": "リンク", "сайт": "サイト",
    "правда": ["本当", "マジ", "ガチ"], "фейк": "偽", "инфа": "情報", "пруф": "証拠",
    "хейтер": "アンチ", "хейтить": "アンチする", "стрим": "配信", "стример": "配信者", "донат": "投銭",
    "скилл": "スキル", "скилловый": "上手い", "нуб": ["初心者", "雑魚", "ヘタクソ"], "про": "プロ", "топ": "トップ", "имба": "ぶっ壊れ", "топчик": "トップ",
    "игра": "ゲーム", "игрок": "プレイヤー", "тима": "チーム", "сквад": "チーム", "рейд": "レイド",
    "аниме": "アニメ", "аниму": "アニメ", "ониме": "アニメ", "онеме": "アニメ", "манга": "漫画", "тян": "ちゃん", "тянка": "ちゃん", "тня": "ちゃん", "кун": "くん", "вайфу": "嫁", "скуф": "スクーフ", "скуфы": "スクーフタチ",
    "дегенерат": "デジェネラット", "шиз": "統合失調症", "русня": "ロシア人", "чушпан": "チュシパン",

# --- Глаголы и действия (Verbs & Actions) ---
    "быть": ["です", "だ", "である"], "является": "です", "был": "だ", "была": "だ", "было": "だ", "были": "だ",
    "есть": "食べる", "ем": "食べる", "ест": "食べる", "едят": "食べる", "ел": "食べた", "ела": "食べた", "ело": "食べた", "ели": "食べた",
    "пить": "飲む", "пью": "飲む", "пьет": "飲む", "пьют": "飲む", "пил": "飲んだ", "пила": "飲んだ", "пило": "飲んだ", "пили": "飲んだ",
    "говорить": "言う", "говорю": "言う", "говорит": "言う", "говорят": "言う", "сказать": "言う", "сказал": "言った", "сказала": "言った", "сказало": "言った", "сказали": "言った", "скажу": "言うだろう",
    "делать": "する", "делаю": "する", "делает": "する", "делают": "する", "сделать": "する", "сделал": "した", "сделала": "した", "сделало": "した", "сделали": "した",
    "смотреть": "見る", "смотрю": "見る", "смотрит": "見る", "смотрят": "見る", "посмотрел": "見た", "посмотрела": "見た", "посмотрело": "見た", "посмотрели": "見た",
    "видеть": "見える", "вижу": "見える", "видит": "見える", "видят": "見える", "увидел": "見えた", "увидела": "見えた", "увидело": "見えた", "увидели": "見えた",
    "идти": "行く", "иду": "行く", "идет": "行く", "идут": "行く", "пошел": "行った", "пошла": "行った", "пошло": "行った", "пошли": "行った",
    "знать": "知る", "знаю": ["知ってる", "分かってる"], "знает": "知ってる", "знают": "知ってる", "узнал": "知った", "узнала": "知った", "узнало": "知った", "узнали": "知った",
    "думать": "思う", "думаю": "思う", "думает": "思う", "думают": "思う", "подумал": "思った", "подумала": "思った", "подумало": "思った", "подумали": "思った",
    "хотеть": "欲しい", "хочу": ["欲しい", "したい"], "хочет": "欲しがっている", "хотят": "欲しがっている", "хотел": "欲しかった", "хотела": "欲しかった", "хотело": "欲しかった", "хотели": "欲しかった",
    "любить": "愛する", "люблю": ["好きだ", "愛してる"], "любит": "愛してる", "любят": "愛してる", "нравится": "好き", "любил": "愛してた", "любила": "愛してた", "любили": "愛してた",
    "мочь": "できる", "могу": "できる", "может": "できる", "могут": "できる", "мог": "できた", "могла": "できた", "могло": "できた", "могли": "できた",
    "ждать": "待つ", "жду": "待ってる", "ждет": "待ってる", "ждут": "待ってる", "подождал": "待った", "подождала": "待った", "подождали": "待った",
    "писать": "書く", "пишу": "書く", "пишет": "書く", "пишут": "書く", "написал": "書いた", "написала": "書いた", "написали": "書いた",
    "читать": "読む", "читаю": "読む", "читает": "読む", "читают": "読む", "прочитал": "読んだ", "прочитала": "読んだ", "прочитали": "読んだ",
    "смеяться": "笑う", "смеюсь": "笑う", "смеется": "笑う", "смеются": "笑う", "засмеялся": "笑った", "засмеялась": "笑った", "засмеялись": "笑った",
    "плакать": "泣く", "плачу": "泣く", "плачет": "泣く", "плачут": "泣く", "заплакал": "泣いた", "заплакала": "泣いた", "заплакали": "泣いた",
    "играть": "遊ぶ", "играю": "遊ぶ", "играет": "遊ぶ", "играют": "遊ぶ", "поиграл": "遊んだ", "поиграла": "遊んだ", "поиграли": "遊んだ",
    "работать": "働く", "работаю": "働く", "работает": "働く", "работают": "働く", "работал": "働いた", "работала": "働いた", "работали": "働いた",
    "жить": "生きる", "живу": "生きてる", "живет": "生きてる", "живут": "生きてる", "жил": "生きた", "жила": "生きた", "жило": "生きた", "жили": "生きた",
    "умереть": "死ぬ", "умираю": "死ぬ", "умирает": "死ぬ", "умирают": "死ぬ", "умер": "死んだ", "умерла": "死んだ", "умерло": "死んだ", "умерли": "死んだ",
    "понимать": "分かる", "понимаю": "分かる", "понимает": "分かる", "понимают": "分かる", "понял": ["分かった", "なるほど"], "поняла": "分かった", "поняли": "分かった",
    "ебу": "ファックする", "ебет": "ファックする", "ебал": "クソだ", "ебёт": "ファックする",
    
# --- Прилагательные и Наречия (Adjectives & Adverbs) ---
    "новый": "新しい", "новая": "新しい", "новое": "新しい", "новые": "新しい",
    "старый": "古い", "старая": "古い", "старое": "古い", "старые": "古い",
    "древний": "古代の", "древняя": "古代の", "древнее": "古代の", "древние": "古代の",
    "молодой": "若い", "молодая": "若い", "молодое": "若い", "молодые": "若い",
    "большой": "大きい", "большая": "大きい", "большое": "大きい", "большие": "大きい",
    "маленький": "小さい", "маленькая": "小さい", "маленькое": "小さい", "маленькие": "小さい",
    "высокий": "高い", "высокая": "高い", "высокое": "高い", "высокие": "高い",
    "низкий": "低い", "низкая": "低い", "низкое": "低い", "низкие": "低い",
    "хороший": "良い", "хорошая": "良い", "хорошее": "良い", "хорошие": "良い", "хорошо": "良く",
    "плохой": "悪い", "плохая": "悪い", "плохое": "悪い", "плохие": "悪い", "плохо": "悪く",
    "красивый": "美しい", "красивая": "美しい", "красивое": "美しい", "красивые": "美しい", "красиво": "美しく",
    "милый": "可愛い", "милая": "可愛い", "милое": "可愛い", "милые": "可愛い", "мило": "可愛く",
    "ужасный": "酷い", "ужасная": "酷い", "ужасное": "酷い", "ужасные": "酷い", "ужасно": "酷く",
    "страшный": "怖い", "страшная": "怖い", "страшное": "怖い", "страшные": "怖い", "страшно": "怖く",
    "веселый": "楽しい", "веселая": "楽しい", "веселое": "楽しい", "веселые": "楽しい", "весело": "楽しく",
    "грустный": "悲しい", "грустная": "悲しい", "грустное": "悲しい", "грустные": "悲しい", "грустно": "悲しく",
    "интересный": "面白い", "интересная": "面白い", "интересное": "面白い", "интересные": "面白い", "интересно": "面白く",
    "скучный": "つまらない", "скучная": "つまらない", "скучное": "つまらない", "скучные": "つまらない", "скучно": "つまらなく",
    "глупый": "馬鹿な", "глупая": "馬鹿な", "глупое": "馬鹿な", "глупые": "馬鹿な", "глупо": "馬鹿に",
    "умный": "賢い", "умная": "賢い", "умное": "賢い", "умные": "賢い", "умно": "賢く",
    "сильный": "強い", "сильная": "強い", "сильное": "強い", "сильные": "強い", "сильно": "強く",
    "слабый": "弱い", "слабая": "弱い", "слабое": "弱い", "слабые": "弱い", "слабо": "弱く",
    "крутой": ["すごい", "かっこいい", "ヤバい"], "крутая": ["すごい", "かっこいい", "ヤバい"], "крутое": ["すごい", "かっこいい", "ヤバい"], "крутые": ["すごい", "かっこいい", "ヤバい"], "круто": ["すごい", "かっこいい", "ヤバい"],
    "странный": "変な", "странная": "変な", "странное": "変な", "странные": "変な", "странно": "変に",
    "горячий": "熱い", "горячая": "熱い", "горячее": "熱い", "горячие": "熱い", "горячо": "熱く",
    "холодный": "冷たい", "холодная": "冷たい", "холодное": "冷たい", "холодные": "冷たい", "холодно": "冷たく",
    "быстрый": "速い", "быстрая": "速い", "быстрое": "速い", "быстрые": "速い", "быстро": "速く",
    "медленный": "遅い", "медленная": "遅い", "медленное": "遅い", "медленные": "遅い", "медленно": "遅く",
    "легкий": "簡単な", "легкая": "簡単な", "легкое": "簡単な", "легкие": "簡単な", "легко": "簡単に",
    "сложный": "難しい", "сложная": "難しい", "сложное": "難しい", "сложные": "難しい", "сложно": "難しく",
    "громкий": "うるさい", "громкая": "うるさい", "громкое": "うるさい", "громкие": "うるさい", "громко": "うるさく",
    "тихий": "静かな", "тихая": "静かな", "тихое": "静かな", "тихие": "静かな", "тихо": "静かに",
    
    # --- Мат и грубости (Swear & Rude words) ---
    "блять": ["くそ", "ちくしょう", "畜生", "チクショウ！"],
    "нахуй": ["クソ！", "チクショウ！", "くたばれ！", "ちくしょう"],
    "пиздец": ["やばい", "マジかよ", "最悪だ", "終わってる", "チクショウ！", "やばい", "最悪だ"],
    "хуй": ["ちんこ", "ちんぽ", "野郎", "チソポ"], "хуи": "ディックス", "пиздеж": ["デタラメ", "出鱈目", "嘘八百", "嘘八百", "たわごと"], "пиздёж": ["デタラメ", "出鱈目", "嘘八百", "嘘八百", "たわごと"], "пиздежу": ["デタラメ", "出鱈目", "嘘八百", "嘘八百", "たわごと"], "пиздёжа": ["デタラメ", "出鱈目", "嘘八百", "嘘八百", "たわごと"],
    "пидор": ["ホモ", "おかま", "ゲイ", "ホモ野郎"], "пидоры": ["ホモ", "おかま", "ゲイ", "ホモ野郎"], "пидору": ["ホモ", "おかま", "ゲイ", "ホモ野郎"], "пидорам": ["ホモ", "おかま", "ゲイ", "ホモ野郎"],
    "сука": ["雌犬", "あばずれ", "この野郎", "やばい", "最悪だ"], "сиськи": "おっぱい",  "суки": ["雌犬", "あばずれ", "この野郎"], "сиська": "おっぱい", "сук": ["雌犬", "あばずれ", "この野郎"],
    "говно": ["うんこ", "クソ", "糞"], "долбаёб": "バカ", "говна": ["うんこ", "クソ", "糞"], "долбаёба": "バカ",  "говну": ["うんこ", "クソ", "糞"], "долбаёбу": "バカ",
    "дерьмо": ["うんこ", "クソ", "糞", "クソ！", "チクショウ！", "くたばれ！", "ちくしょう"], "долбоеб": "バカ", "дерьму": ["うんこ", "クソ", "糞"], "долбоебу": "バカ", "долбоебп": "バカ",
    "хуйня": ["うんこ", "クソ", "糞", "やばい", "最悪だ"], "долбоёб": "バカ", "хуйни": ["うんこ", "クソ", "糞"], "долбоёбу": "バカ", "долбоёба": "バカ", "хуйню": ["うんこ", "クソ", "糞"],
    "ебать": ["気が狂う", "クソ", "クソ！", "チクショウ！", "くたばれ！", "ちくしょう", "マジか", "信じられない"], "еблан": "バカ", "анал": "肛門", "ебланы": "クソ野郎ども",  "долбаёбы": "バカ者", "долбоебы": ["馬鹿共", "アホども", "馬鹿野郎ども", "トンチキども"], "долбоёбы": "バカ者",
    "хуета": ["うんこ", "クソ", "糞"], "долбаеб": "バカ", "ебанат": "バカ", "долбаебы": "バカ者", "ебанаты": "バカ者", "хуете": ["うんこ", "クソ", "糞"], "хуету": ["うんこ", "クソ", "糞"],
    "пизда": ["女性器", "プッシー", "まんこ", "やばい", "最悪だ"], "ебануться": "気が狂う", "даун": "埋もれよ", "пизде": ["女性器", "プッシー", "まんこ"], "пизду": ["女性器", "プッシー", "まんこ"],
    "жопа": ["ケツ", "けつ"], "попа": "お尻", "попец": "お尻", "срака": "お尻", "мудак": ["ろくでなし", "くそったれ"], "жопе": ["ケツ", "けつ"], "попе": "お尻", "жопу": ["ケツ", "けつ"], "попу": "お尻",
    "идиот": ["馬鹿", "アホ", "馬鹿野郎", "トンチキ"], "очко": "肛門", "анус": "肛門", "хуец": "ちんこ", "попка": "お尻", "идиоты": ["馬鹿共", "アホども", "馬鹿野郎ども", "トンチキども"], "идиотам": ["馬鹿共", "アホども", "馬鹿野郎ども", "トンチキども"],
    "дебил": "低能",  "дебилу": "低能", "дебилы": "低能ども", "дебилам": "低能ども", "урод": "ブス", "уродам": "ブスども", "уроды": "ブスども", "мразь": "クズ", "мрази": "クズども", "мразям": "クズども", "хуйло": "バカ野郎", "отъебись": "ほっといて", "гандон": "低能", "гандону": "低能", "гандоны": "低能ども", "гандонам": "低能ども",
    "заткнись": ["うるさい", "黙れ", "だまれクソ"], "отвали": "ほっといて", "умри": ["死ね", "埋もれよ", "消えろ！", "くたばれ！"], "сдохни": ["死ね", "埋もれよ", "消えろ！", "くたばれ！"], "завались": ["うるさい", "黙れ", "だまれクソ", "くたばれ！"], "завали": ["うるさい", "黙れ", "だまれクソ", "くたばれ！"],


    
# --- Междометия и сленг (Exclamations & Slang) ---
    "вау": ["うわー", "すげー"], "ого": "おお", "воу": ["うわー", "すげー"], "офигеть": ["やべえ", "すげえ"], "ничего себе": ["マジか", "すごい"],
    "упс": "おっと", "черт": "ちぇっ", "блин": ["もう", "しまった"], "бля": ["くそ", "ちくしょう"],
    "жиза": ["それな", "わかる"], "забей": ["気にしないで", "ドンマイ"], "реально": ["マジで", "本当に"], "серьезно": ["マジで", "本気で"],
    "короче": ["とにかく", "要するに"], "типа": ["みたいな", "って感じ"], "кстати": ["ちなみに", "ところで"],
    "ну": ["ええと", "あの"], "нуу": ["ええとー", "あのー"], "нууу": ["ええとーー", "あのーー"], "эм": "うーん", "хм": "ふむ",
    "эй": ["おい", "ねえ"], "хэй": "おい",
    "ага": "うん", "угу": "うん", "окей": ["オッケー", "OK", "了解"], "ок": ["オッケー", "了解"],
    "давай": ["じゃあ", "やろう"], "го": ["行こう", "やろう"], "гоу": ["行こうぜ", "やろう"],
    "стоп": ["待って", "ストップ"], "помогите": "助けて", "хелп": "助けて",
    "понял": ["分かった", "了解"], "понятно": "なるほど",
    "печаль": "残念", "беда": "大変だ", "удачи": "頑張って",
}

# Множество местоимений для быстрой проверки
PRONOUNS = {"я", "ты", "вы", "он", "она", "мы", "они", "это", "то"}

# --- Остальные константы без изменений ---
HIRAGANA_MAP = {
    'а': 'あ', 'и': 'い', 'у': 'う', 'э': 'え', 'о': 'お', 'е': 'え', 'ка': 'か', 'ки': 'き', 'ку': 'く', 'кэ': 'け', 'ке': 'け', 'ко': 'こ', 'кя': 'きゃ', 'кю': 'きゅ', 'кё': 'きょ', 'га': 'が', 'ги': 'ぎ', 'гу': 'ぐ', 'гэ': 'げ', 'ге': 'げ', 'го': 'ご', 'гя': 'ぎゃ', 'гю': 'ぎゅ', 'гё': 'ぎょ', 'са': 'さ', 'си': 'し', 'су': 'す', 'сэ': 'せ', 'со': 'そ', 'ся': 'しゃ', 'сю': 'しゅ', 'сё': 'しょ', 'за': 'ざ', 'зи': 'じ', 'зу': 'ず', 'зэ': 'ぜ', 'зо': 'ぞ', 'зя': 'じゃ', 'зю': 'じゅ', 'зё': 'じょ', 'та': 'た', 'ти': 'ち', 'тэ': 'て', 'те': 'て', 'то': 'と', 'цу': 'つ', 'тсу': 'つ', 'тя': 'ちゃ', 'тю': 'ちゅ', 'тё': 'ちょ', 'да': 'だ', 'ди': 'ぢ', 'дэ': 'で', 'де': 'で', 'до': 'ど', 'дзу': 'づ', 'ду': 'づ', 'дя': 'ぢゃ', 'дю': 'ぢゅ', 'дё': 'ぢょ', 'на': 'な', 'ни': 'に', 'ну': 'ぬ', 'нэ': 'ね', 'не': 'ね', 'но': 'の', 'ня': 'にゃ', 'ню': 'にゅ', 'нё': 'にょ', 'ха': 'は', 'хи': 'ひ', 'ху': 'ふ', 'хэ': 'へ', 'хе': 'へ', 'хо': 'ほ', 'хя': 'ひゃ', 'хю': 'ひゅ', 'хё': 'ひょ', 'ба': 'ば', 'би': 'び', 'бу': 'ぶ', 'бэ': 'べ', 'бе': 'べ', 'бо': 'ぼ', 'бя': 'びゃ', 'бю': 'びゅ', 'бё': 'びょ', 'па': 'ぱ', 'пи': 'ぴ', 'пу': 'ぷ', 'пэ': 'ぺ', 'пе': 'ぺ', 'по': 'ぽ', 'пя': 'ぴゃ', 'пю': 'ぴゅ', 'пё': 'ぴょ', 'ма': 'ま', 'ми': 'み', 'му': 'む', 'мэ': 'め', 'ме': 'め', 'мо': 'も', 'мя': 'みゃ', 'мю': 'みゅ', 'мё': 'みょ', 'ра': 'ら', 'ри': 'り', 'ру': 'る', 'рэ': 'れ', 'ре': 'れ', 'ро': 'ろ', 'ря': 'りゃ', 'рю': 'りゅ', 'рё': 'りょ', 'ва': 'わ', 'ви': 'うぃ', 'вэ': 'うぇ', 'во': 'を', 'ве': 'うぇ', 'фа': 'ふぁ', 'фи': 'ふぃ', 'фу': 'ふ', 'фэ': 'ふぇ', 'фо': 'ふぉ', 'йа': 'や', 'йу': 'ゆ', 'йо': 'よ', 'я': 'や', 'ю': 'ゆ', 'ла': 'ら', 'ли': 'り', 'лэ': 'れ', 'ле': 'れ', 'лу': 'る', 'ло': 'ろ', 'ля': 'りゃ', 'лю': 'りゅ', 'лё': 'りょ', 'ща': 'しゃ', 'щу': 'しゅ', 'що': 'しょ', 'ще': 'しぇ', 'щэ': 'しぇ', 'ча': 'ちゃ', 'чу': 'ちゅ', 'чо': 'ちょ', 'че': 'ちぇ', 'ц': 'つ', 'ца': 'つぁ', 'цо': 'つぉ', 'це': 'つぇ', 'цы': 'つぃ', 'цю': 'つゅ', 'цэ': 'つぇ', 'ж': 'じ', 'жа': 'じゃ', 'же': 'じぇ', 'жи': 'じ', 'жо': 'じょ', 'жу': 'じゅ', 'жэ': 'じぇ', 'ш': 'し', 'ша': 'しゃ', 'ше': 'しぇ', 'ши': 'し', 'шо': 'しょ', 'шу': 'しゅ', 'й': 'い', 'ь': '', 'ъ': '', 'ы': 'い', 'йи': 'い', 'йы': 'い', 'в': 'ゔ', 'ва': 'ゔぁ', 'ве': 'ゔぇ', 'ви': 'ゔぃ', 'во': 'ゔぉ', 'ву': 'ゔ', 'дж': 'ぢ', 'дз': 'づ', 'джа': 'ぢゃ', 'дже': 'ぢぇ', 'джо': 'ぢょ', 'джу': 'ぢゅ', 'кс': 'くす', 'гз': 'ぐず', 'кв': 'くゔ', 'тс': 'つ', 'тьс': 'つ', 'нь': 'ん', 'рр': 'っら', 'сс': 'っさ', 'тт': 'った', 'пп': 'っぱ', 'йе': 'いぇ', 'йэ': 'いぇ', 'йё': 'いよ', 'йя': 'いや', 'тр': 'とら', 'др': 'どら', 'стр': 'すとら', 'кр': 'くら', 'гр': 'ぐら', 'пр': 'ぷら', 'бр': 'ぶら', 'фр': 'ふら', 'вр': 'ゔら', 'зр': 'ずら', 'кл': 'くら', 'гл': 'ぐら', 'пл': 'ぷら', 'бл': 'ぶら', 'фл': 'ふら', 'вл': 'ゔら', 'сл': 'すら', 'зл': 'ずら', 'тл': 'とら', 'дл': 'どら', 'кт': 'くと', 'гт': 'ぐと', 'пт': 'ぷと', 'бт': 'ぶと', 'фт': 'ふと', 'вт': 'ゔと', 'ст': 'すと', 'зт': 'ずと', 'хт': 'ひと', 'цт': 'つと', 'чт': 'ちと', 'шт': 'しと', 'щт': 'しと', 'ск': 'すく', 'зк': 'ずく', 'б': 'ぶ', 'в': 'ゔ', 'г': 'ぐ', 'д': 'ど', 'ж': 'じ', 'з': 'ず', 'к': 'く', 'л': 'る', 'м': 'む', 'н': 'ん', 'п': 'ぷ', 'р': 'ら', 'с': 'す', 'т': 'と', 'ф': 'ふ', 'х': 'ひ', 'ц': 'つ', 'ч': 'ち', 'ш': 'し', 'щ': 'し', 'ё': 'よ'
}
KATAKANA_MAP = {
    'а': 'ア', 'и': 'イ', 'у': 'ウ', 'э': 'エ', 'о': 'オ', 'е': 'エ', 'ка': 'カ', 'ки': 'キ', 'ку': 'ク', 'кэ': 'ケ', 'ко': 'コ', 'ке': 'ケ', 'кя': 'キャ', 'кю': 'キュ', 'кё': 'キョ', 'га': 'ガ', 'ги': 'ギ', 'гу': 'グ', 'гэ': 'ゲ', 'го': 'ゴ', 'ге': 'ゲ', 'гя': 'ギャ', 'гю': 'ギュ', 'гё': 'ギョ', 'са': 'サ', 'си': 'シ', 'су': 'ス', 'сэ': 'セ', 'со': 'ソ', 'се': 'セ', 'ся': 'シャ', 'сю': 'シュ', 'сё': 'ショ', 'за': 'ザ', 'зи': 'ジ', 'зу': 'ズ', 'зэ': 'ゼ', 'зо': 'ゾ', 'зе': 'ゼ', 'зя': 'ジャ', 'зю': 'ジュ', 'зё': 'ジョ', 'та': 'タ', 'ти': 'チ', 'тэ': 'テ', 'то': 'ト', 'цу': 'ツ', 'те': 'テ', 'тя': 'チャ', 'тю': 'チュ', 'тё': 'チョ', 'да': 'ダ', 'ди': 'ヂ', 'дэ': 'デ', 'до': 'ド', 'дзу': 'ヅ', 'де': 'デ', 'дя': 'ヂャ', 'дю': 'ヂュ', 'дё': 'ヂョ', 'на': 'ナ', 'ни': 'ニ', 'ну': 'ヌ', 'нэ': 'ネ', 'но': 'ノ', 'не': 'ネ', 'ня': 'ニャ', 'ню': 'ニュ', 'нё': 'ニョ', 'ха': 'ハ', 'хи': 'ヒ', 'ху': 'フ', 'хэ': 'ヘ', 'хо': 'ホ', 'хе': 'ヘ', 'хя': 'ヒャ', 'хю': 'ヒュ', 'хё': 'ヒョ', 'ба': 'バ', 'би': 'ビ', 'бу': 'ブ', 'бэ': 'ベ', 'бо': 'ボ', 'бе': 'ベ', 'бя': 'ビャ', 'бю': 'ビュ', 'бё': 'ビョ', 'па': 'パ', 'пи': 'ピ', 'пу': 'プ', 'пэ': 'ペ', 'по': 'ポ', 'пе': 'ペ', 'пя': 'ピャ', 'пю': 'ピュ', 'пё': 'ピョ', 'ма': 'マ', 'ми': 'ミ', 'му': 'ム', 'мэ': 'メ', 'мо': 'モ', 'ме': 'メ', 'мя': 'ミャ', 'мю': 'ミュ', 'мё': 'ミョ', 'ра': 'ラ', 'ри': 'リ', 'ру': 'ル', 'рэ': 'レ', 'ро': 'ロ', 'ре': 'レ', 'ря': 'リャ', 'рю': 'リュ', 'рё': 'リョ', 'ва': 'ワ', 'ви': 'ウィ', 'вэ': 'ウェ', 'во': 'ヲ', 'фа': 'ファ', 'фи': 'フィ', 'фу': 'フ', 'фэ': 'フェ', 'фо': 'フォ', 'фе': 'フェ', 'йа': 'ヤ', 'йу': 'ユ', 'йо': 'ヨ', 'я': 'ヤ', 'ю': 'ユ', 'ла': 'ラ', 'ли': 'リ', 'лэ': 'レ', 'ле': 'レ', 'лу': 'ル', 'ло': 'ロ', 'ля': 'リャ', 'лю': 'リュ', 'лё': 'リョ', 'ща': 'シャ', 'щу': 'シュ', 'що': 'ショ', 'ще': 'シェ', 'ча': 'チャ', 'чу': 'チュ', 'чо': 'チョ', 'че': 'チェ', 'ц': 'ツ', 'ца': 'ツァ', 'цо': 'ツォ', 'це': 'ツェ', 'цы': 'ツィ', 'цю': 'ツュ', 'ж': 'ジ', 'жа': 'ジャ', 'же': 'ジェ', 'жи': 'ジ', 'жо': 'ジョ', 'жу': 'ジュ', 'ш': 'シ', 'ша': 'シャ', 'ше': 'シェ', 'ши': 'シ', 'шо': 'ショ', 'шу': 'シュ', 'й': 'イ', 'ь': '', 'ъ': '', 'ы': 'イ', 'йи': 'イ', 'йы': 'イ', 'в': 'ヴ', 'ва': 'ヴァ', 'ве': 'ヴェ', 'ви': 'ヴィ', 'во': 'ヴォ', 'ву': 'ヴ', 'дж': 'ヂ', 'дз': 'ヅ', 'джа': 'ヂャ', 'дже': 'ヂェ', 'джо': 'ヂョ', 'джу': 'ヂュ', 'кс': 'クス', 'гз': 'グズ', 'кв': 'クヴ', 'тс': 'ツ', 'тьс': 'ツ', 'нь': 'ン', 'рр': 'ッラ', 'сс': 'ッサ', 'тт': 'ッタ', 'пп': 'ッパ', 'йе': 'イェ', 'йэ': 'イェ', 'йё': 'イヨ', 'йя': 'イヤ', 'б': 'ブ', 'в': 'ヴ', 'г': 'グ', 'д': 'ド', 'ж': 'ジ', 'з': 'ズ', 'к': 'ク', 'л': 'ル', 'м': 'ム', 'н': 'ン', 'п': 'プ', 'р': 'ラ', 'с': 'ス', 'т': 'ト', 'ф': 'フ', 'х': 'ヒ', 'ц': 'ツ', 'ч': 'チ', 'ш': 'シ', 'щ': 'シ', 'ё': 'ヨ'
}
NUMERALS = {0: '零', 1: '一', 2: '二', 3: '三', 4: '四', 5: '五', 6: '六', 7: '七', 8: '八', 9: '九', 10: '十', 100: '百', 1000: '千', 10000: '万', 100000000: '億', 1000000000000: '兆'}
PARTICLES = ['ね', 'よ', 'か', 'わ', 'の', 'な', 'ぞ', 'ぜ', 'が', 'に', 'で', 'と', 'も', 'や', 'さ', 'かしら', 'とも', 'って', 'たら', 'のに', 'ので', 'から', 'し', 'こと']
NYA_INTERJECTIONS = ['にゃあ', 'にゃん', 'にゃーん', 'にゃお', 'みゃあ', 'にゃっ', 'にゃんにゃん', 'にゃー', 'にゃんぱすー']
END_PHRASES = ['です', 'ですね', 'ですよ', 'ですわ', 'なのです', 'かもしれません', 'でしょう', 'だろう', 'かもね', 'に違いない', 'に決まってる', 'だと思う', 'かな', 'なんだよね', 'ってこと', 'わけ', 'はず', 'みたい', 'そう', 'らしい', 'ようだ', 'みたいだ', '感じ', '気がする']
KAWAII_EMOJIS = [' (´∀｀) ', ' (￣ω￣) ', ' (◕‿◕) ', ' (⁄ ⁄>⁄ ▽⁄<⁄ ⁄) ', ' (✿◠‿◠) ', ' (◡‿◡✿) ', ' (=^･ｪ･^=) ', ' (●´ω｀●) ', ' ヾ(≧▽≦*)o ', ' (｡･ω･｡) ', ' (づ｡◕‿‿◕｡)づ ', ' (ﾉ◕ヮ◕)ﾉ*:･ﾟ✧ ', ' (´｡• ω •｡`) ', ' (っ◕‿◕)っ ', ' (づ￣ ³￣)づ ', ' (●´艸`) ', ' (✪‿✪)ノ ', ' ^_^', ' >_<', ' T_T', ' :3', ' :D', ' <3', ' (｡>﹏<｡) ', ' (╯°□°）╯︵ ┻━┻ ', ' ヽ(´▽`)/ ', ' ( ͡° ͜ʖ ͡°)']

def convert_number(num_str):
    try:
        num = int(num_str)
        if num >= 10**16: return num_str
        if num == 0: return NUMERALS[0]
        result, units = [], [1000000000000, 100000000, 10000, 1000, 100, 10, 1]
        for unit in units:
            if num < unit: continue
            count, num = divmod(num, unit)
            if count > 1 or unit == 1:
                result.append(convert_number(str(count)) if count >= 10 else NUMERALS[count])
            if unit > 1: result.append(NUMERALS[unit])
        return ''.join(result)
    except Exception: return num_str

def transliterate_word(word, kana_map):
    word = re.sub(r'ться$', 'тсу', word)
    word = re.sub(r'тся$', 'тса', word)
    word = re.sub(r'([бвгджзйклмнпрстфхцчшщ])\1', lambda m: ('っ' if kana_map is HIRAGANA_MAP else 'ッ') + m.group(1), word)
    word = re.sub(r'([бвгджзйклмнпрстфхцчшщ])ь([ауоыэеёюяи])', lambda m: m.group(1) + {'а': 'я', 'у': 'ю', 'о': 'ё', 'э': 'е', 'е': 'е', 'ы': 'и', 'ё': 'ё', 'ю': 'ю', 'я': 'я', 'и': 'и'}[m.group(2)], word)
    result = []
    while word:
        found = False
        for length in range(min(3, len(word)), 0, -1):
            syllable = word[:length]
            if syllable in kana_map:
                result.append(kana_map[syllable])
                word = word[length:]
                found = True
                break
        if not found:
            result.append(word[0])
            word = word[1:]
    return ''.join(result)

def to_kana(text, kana_map):
    tokens = re.findall(r'[\w-]+|[^\w\s-]', text.lower())
    result = []
    for token in tokens:
        if token.isdigit():
            result.append(convert_number(token))
        elif re.match(r'^[a-zA-Zа-яА-ЯёЁ-]+$', token):
            result.append(transliterate_word(token, kana_map))
        else:
            result.append(token)
    return ''.join(result)


def anime_transform(text):
    """Гибридная функция преобразования в аниме-стиль с улучшенной грамматикой и обработкой смеха."""
    if not text.strip():
        return text

    # --- ИЗМЕНЕНИЕ: Предварительная обработка смеха ---
    # Паттерн для поиска повторяющихся "ах", "ха", "хв" и т.д. длиной 4+ символов
    laugh_pattern = r'([ахвхвaхвхв]+[ахвхвaхвхв]{3,})'
    japanese_laughs = ["草", "www", "（笑）", "www草", "大草原"]
    text = re.sub(laugh_pattern, lambda m: random.choice(japanese_laughs), text, flags=re.IGNORECASE)

    words = text.split(' ')
    transformed_words = []
    kana_map = random.choice([HIRAGANA_MAP, KATAKANA_MAP])

    for word in words:
        if not word: continue
        
        match = re.match(r'^(.+?)([.,!?;:]+)$', word)
        if match:
            clean_word, punctuation = match.groups()
        else:
            clean_word, punctuation = word, ''
        base_word = clean_word.lower()

        if base_word in JAPANESE_WORD_REPLACEMENTS:
            translation = JAPANESE_WORD_REPLACEMENTS[base_word]
            translated_word = random.choice(translation) if isinstance(translation, list) else translation
            
            if base_word in PRONOUNS:
                if random.random() < 0.7:
                    translated_word += 'は'
                else:
                    translated_word += 'が'
            
            transformed_words.append(translated_word + punctuation)
        else:
            transliterated_word = to_kana(clean_word, kana_map)
            transformed_words.append(transliterated_word + punctuation)

    final_words = []
    for word in transformed_words:
        final_words.append(word)
        if random.random() < 0.15:
            final_words[-1] += random.choice(PARTICLES)
        if random.random() < 0.10:
            final_words[-1] += random.choice(NYA_INTERJECTIONS)
        if random.random() < 0.08:
            final_words.append(random.choice(KAWAII_EMOJIS).strip())

    result = ' '.join(final_words)

    if random.random() < 0.35:
        result += random.choice(END_PHRASES)

    if random.random() < 0.5:
        result += random.choice(KAWAII_EMOJIS)
        
    return result.strip()


async def get_random_anime_image():
    """Получает URL случайной аниме-картинки с API"""
    apis = [
        "https://api.waifu.pics/sfw/waifu",
        "https://api.waifu.im/search/?included_tags=waifu"
    ]
    random.shuffle(apis)

    for api_url in apis:
        try:
            async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=3)) as session:
                async with session.get(api_url) as response:
                    if response.status == 200:
                        data = await response.json()
                        if "api.waifu.pics" in api_url and data and 'url' in data:
                            return data['url']
                        if "api.waifu.im" in api_url and data and 'images' in data and data['images']:
                            return data['images'][0]['url']
        except Exception as e:
            print(f"Ошибка API {api_url}: {e}")
            continue
            
    return None
